<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Profile - FC 2025 League Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');
        
        :root {
            --primary-color: #f8f9fa;
            --secondary-color: #00b894;
            --text-color: #333;
            --container-bg: rgba(255, 255, 255, 0.85);
            --card-bg: rgba(255, 255, 255, 0.9);
            --border-color: #e9ecef;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary-color);
            color: var(--text-color);
            transition: background-color 0.5s, color 0.5s;
        }
        .container {
            max-width: 90%;
            margin: 2rem auto;
            padding: 2rem;
            background-color: var(--container-bg);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: var(--secondary-color);
            font-weight: 700;
            transition: color 0.5s;
        }
        a {
            color: var(--secondary-color);
            transition: color 0.2s;
        }
        a:hover {
            filter: brightness(1.2);
        }
        .stat-card, .trophy-card, .title-card {
             background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            margin-top: 1.5rem;
        }
        .trophy, .special-title {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .trophy:last-child, .special-title:last-child {
            border-bottom: none;
        }
        .trophy-icon, .title-icon {
            font-size: 2rem;
            margin-right: 1rem;
        }
        .player-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .player-avatar {
            width: 128px;
            height: 128px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--secondary-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .match-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .favorite-club-card {
             display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .favorite-club-logo {
            max-height: 80px;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="playerHeader" class="player-header">
             <img id="playerAvatar" src="https://placehold.co/128x128/e9ecef/495057?text=?" alt="Player Avatar" class="player-avatar">
            <h1 id="playerName" class="text-4xl font-extrabold text-center">Loading...</h1>
            <p id="playerEmail" class="opacity-70"></p>
        </div>
        <p class="text-center mt-4"><a href="index.html" class="hover:underline">← Back to Main Page</a></p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
            <div class="stat-card md:col-span-2">
                <h2 class="text-2xl mb-4">Career Statistics</h2>
                <div id="careerStats" class="grid grid-cols-2 gap-4"></div>
            </div>
            <div class="flex flex-col gap-6">
                <div class="stat-card favorite-club-card">
                    <h2 class="text-2xl mb-4">Favorite Club</h2>
                    <div id="favoriteClub"></div>
                </div>
                <div class="trophy-card">
                    <h2 class="text-2xl mb-4">Trophy Cabinet</h2>
                    <div id="trophyCabinet" class="max-h-[200px] overflow-y-auto"></div>
                </div>
            </div>
             <div class="title-card md:col-span-3">
                <h2 class="text-2xl mb-4">Special Titles</h2>
                <div id="specialTitles" class="max-h-96 overflow-y-auto"></div>
            </div>
        </div>
        
        <div class="stat-card">
             <h2 class="text-2xl mb-4">Match History</h2>
             <div id="matchHistory" class="max-h-96 overflow-y-auto"></div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBvXdFou9yUlERH-iaICi6JjNChw1rC2O0",
          authDomain: "fun-league-6edd6.firebaseapp.com",
          projectId: "fun-league-6edd6",
          storageBucket: "fun-league-6edd6.appspot.com",
          messagingSenderId: "132854098604",
          appId: "1:132854098604:web:0c0e829ac99624dac38d09",
          measurementId: "G-QJCY28B9HM"
        };
        
        // Club Theme Database
        const clubThemes = {
            'Real Madrid': { primary: '#FEBE10', secondary: '#00529F', text: '#FFFFFF', bg: '#FFFFFF' },
            'FC Barcelona': { primary: '#A50044', secondary: '#004D98', text: '#FFFFFF', bg: '#004D98' },
            'Manchester United': { primary: '#DA291C', secondary: '#FBE122', text: '#000000', bg: '#DA291C' },
            'Liverpool FC': { primary: '#C8102E', secondary: '#00B2A9', text: '#FFFFFF', bg: '#C8102E' },
            'Manchester City': { primary: '#6CABDD', secondary: '#FFFFFF', text: '#00285E', bg: '#6CABDD' },
            'Arsenal FC': { primary: '#EF0107', secondary: '#FFFFFF', text: '#063672', bg: '#EF0107' },
            'Chelsea FC': { primary: '#034694', secondary: '#FFFFFF', text: '#FFFFFF', bg: '#034694' },
            'FC Bayern Munich': { primary: '#DC052D', secondary: '#FFFFFF', text: '#0066B2', bg: '#DC052D' },
            'Juventus FC': { primary: '#FFFFFF', secondary: '#000000', text: '#000000', bg: '#FFFFFF' },
            'AC Milan': { primary: '#FB090B', secondary: '#000000', text: '#FFFFFF', bg: '#FB090B' },
            'Inter Milan': { primary: '#0068A8', secondary: '#FFFFFF', text: '#000000', bg: '#0068A8' },
            'Paris Saint-Germain (PSG)': { primary: '#004170', secondary: '#DA291C', text: '#FFFFFF', bg: '#004170' },
            'Tottenham Hotspur F.C.': { primary: '#132257', secondary: '#FFFFFF', text: '#FFFFFF', bg: '#132257' },
            'Atlético de Madrid': { primary: '#CB3524', secondary: '#FFFFFF', text: '#272E61', bg: '#CB3524' },
            'Borussia Dortmund': { primary: '#FDE100', secondary: '#000000', text: '#000000', bg: '#FDE100' },
            'Newcastle United F.C.': { primary: '#241F20', secondary: '#FFFFFF', text: '#FFFFFF', bg: '#241F20' }
        };

        const playerNameEl = document.getElementById('playerName');
        const playerEmailEl = document.getElementById('playerEmail');
        const playerAvatarEl = document.getElementById('playerAvatar');
        const careerStatsEl = document.getElementById('careerStats');
        const trophyCabinetEl = document.getElementById('trophyCabinet');
        const specialTitlesEl = document.getElementById('specialTitles');
        const matchHistoryEl = document.getElementById('matchHistory');
        const favoriteClubEl = document.getElementById('favoriteClub');

        function applyTheme(theme) {
            const root = document.documentElement;
            root.style.setProperty('--primary-color', theme.bg);
            root.style.setProperty('--secondary-color', theme.secondary);
            root.style.setProperty('--text-color', theme.text);
            root.style.setProperty('--container-bg', theme.bg === '#FFFFFF' ? 'rgba(248, 249, 250, 0.85)' : `rgba(255,255,255,0.1)`);
            root.style.setProperty('--card-bg', theme.bg === '#FFFFFF' ? 'rgba(255, 255, 255, 0.9)' : `rgba(0,0,0,0.1)`);
            root.style.setProperty('--border-color', `rgba(${theme.text === '#FFFFFF' ? '255,255,255' : '0,0,0'}, 0.1)`);
        }

        async function startApp() {
            const params = new URLSearchParams(window.location.search);
            const playerName = params.get('player');

            if (!playerName) {
                playerNameEl.textContent = "Player Not Found";
                return;
            }
            playerNameEl.textContent = playerName;

            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                await signInAnonymously(auth); 
                const db = getFirestore(app);

                const playersSnapshot = await getDocs(collection(db, 'players'));
                const matchesSnapshot = await getDocs(query(collection(db, 'matches'), where('status', '==', 'completed')));
                const honorsSnapshot = await getDocs(query(collection(db, 'honors'), where('playerName', '==', playerName)));
                const clubAssignmentsSnapshot = await getDocs(collection(db, 'clubAssignments'));
                const clubsSnapshot = await getDocs(collection(db, 'clubs'));

                const allPlayers = playersSnapshot.docs.map(doc => doc.data());
                const allMatches = matchesSnapshot.docs.map(doc => doc.data());
                const honors = honorsSnapshot.docs.map(doc => doc.data());
                
                const playerData = allPlayers.find(p => p.name === playerName);
                const clubs = clubsSnapshot.docs.map(doc => doc.data());
                const clubAssignments = {};
                clubAssignmentsSnapshot.forEach(doc => { clubAssignments[doc.id] = doc.data() });

                calculateAndRenderProfile(playerData, allPlayers, allMatches, honors, clubAssignments, clubs);

            } catch (error) {
                console.error("Error loading profile:", error);
                playerNameEl.textContent = "Error loading profile";
            }
        }

        function calculateAndRenderProfile(playerData, allPlayers, allMatches, honors, clubAssignments, allClubs) {
            const playerName = playerData.name;
            playerEmailEl.textContent = playerData.email || '';
            if (playerData.avatarUrl) {
                playerAvatarEl.src = playerData.avatarUrl;
            }

            // Apply theme
            const favoriteClubName = playerData.favoriteClub;
            const theme = clubThemes[favoriteClubName];
            if (theme) {
                applyTheme(theme);
            }

            // Render favorite club
            const favoriteClubData = allClubs.find(c => c.name === favoriteClubName);
            if (favoriteClubData) {
                favoriteClubEl.innerHTML = `
                    <img src="${favoriteClubData.logoUrl}" alt="${favoriteClubData.name}" class="favorite-club-logo">
                    <p class="font-bold">${favoriteClubData.name}</p>
                `;
            } else {
                 favoriteClubEl.innerHTML = `<p>No favorite club selected.</p>`;
            }

            const playerMatches = allMatches.filter(m => m.player1Name === playerName || m.player2Name === playerName);
            
            let wins = 0, losses = 0, draws = 0, gf = 0, ga = 0, biggestWin = { diff: 0, score: 'N/A' };
            let worstLoss = { diff: 0, score: 'N/A' };
            const lossesTo = {};
            const winsAgainst = {};

            playerMatches.forEach(m => {
                const isPlayer1 = m.player1Name === playerName;
                const pGoals = isPlayer1 ? m.player1Goals : m.player2Goals;
                const oGoals = isPlayer1 ? m.player2Goals : m.player1Goals;
                const opponentName = isPlayer1 ? m.player2Name : m.player1Name;

                gf += pGoals; ga += oGoals;
                
                if (pGoals > oGoals) {
                    wins++;
                    winsAgainst[opponentName] = (winsAgainst[opponentName] || 0) + 1;
                    if (pGoals - oGoals > biggestWin.diff) biggestWin = { diff: pGoals - oGoals, score: `${pGoals} - ${oGoals}` };
                } else if (oGoals > pGoals) {
                    losses++;
                    lossesTo[opponentName] = (lossesTo[opponentName] || 0) + 1;
                    if (oGoals - pGoals > worstLoss.diff) worstLoss = { diff: oGoals - pGoals, score: `${pGoals} - ${oGoals}` };
                } else {
                    draws++;
                }
            });
            
            const played = playerMatches.length;
            const winRate = played ? ((wins / played) * 100).toFixed(1) : 0;
            const gpg = played ? (gf / played).toFixed(2) : 0;
            
            let nemesisName = 'None', maxLosses = 0;
            for (const opponent in lossesTo) {
                if (lossesTo[opponent] > maxLosses) {
                    maxLosses = lossesTo[opponent];
                    nemesisName = opponent;
                }
            }

            let favoriteOpponent = 'None', maxWins = 0;
             for (const opponent in winsAgainst) {
                if (winsAgainst[opponent] > maxWins) {
                    maxWins = winsAgainst[opponent];
                    favoriteOpponent = opponent;
                }
            }

            careerStatsEl.innerHTML = `
                <p><strong>Win Rate:</strong> ${winRate}%</p><p><strong>Played:</strong> ${played}</p>
                <p><strong>Record (W-D-L):</strong> ${wins}-${draws}-${losses}</p><p><strong>Goals per Game:</strong> ${gpg}</p>
                <p><strong>Goals For:</strong> ${gf}</p><p><strong>Goals Against:</strong> ${ga}</p>
                <p><strong>Biggest Win:</strong> ${biggestWin.score}</p>
                <p><strong>Crushing Defeat:</strong> ${worstLoss.score}</p>
                <p class="col-span-2"><strong>Nemesis:</strong> ${nemesisName === 'None' ? 'None' : `${nemesisName} (${maxLosses} losses)`}</p>
                 <p class="col-span-2"><strong>Favorite Opponent:</strong> ${favoriteOpponent === 'None' ? 'None' : `${favoriteOpponent} (${maxWins} wins)`}</p>
            `;

            const awardIcons = {
                'Gold Medal': '🥇', 'Silver Medal': '🥈', 'Bronze Medal': '🥉',
                'Top Scorer': '⚽', 'Best Defender': '🛡️'
            };

            trophyCabinetEl.innerHTML = honors.sort((a,b) => b.timestamp - a.timestamp).map(honor => {
                const date = honor.leagueDate ? new Date(honor.leagueDate).toLocaleDateString() : new Date(honor.timestamp).toLocaleDateString();
                return `<div class="trophy"><span class="trophy-icon">${awardIcons[honor.award] || '🏆'}</span><div><p class="font-bold">${honor.award}</p><p class="text-sm opacity-70">${honor.leagueName} (${date})</p></div></div>`
            }).join('') || '<p>No honors earned yet.</p>';
            
            // Calculate and Render Special Titles
            renderSpecialTitles(playerName, allPlayers, allMatches, honors);
            
            matchHistoryEl.innerHTML = playerMatches.sort((a,b) => b.timestamp - a.timestamp).map(m => {
                 const p1Club = clubAssignments[m.league]?.[m.player1Name] || '';
                 const p2Club = clubAssignments[m.league]?.[m.player2Name] || '';
                 return `<div class="match-item"><span>${m.league}: ${m.player1Name} ${p1Club ? `(${p1Club})` : ''} <b>${m.player1Goals}</b> - <b>${m.player2Goals}</b> ${m.player2Name} ${p2Club ? `(${p2Club})` : ''}</span></div>`
             }).join('') || '<p>No matches played.</p>';
        }

        function renderSpecialTitles(currentPlayerName, allPlayers, allMatches, allHonors) {
            let titlesHTML = '';
            
            const playerStats = allPlayers.map(p => {
                const pMatches = allMatches.filter(m => m.player1Name === p.name || m.player2Name === p.name);
                let gf = 0, ga = 0, draws = 0, cleanSheets = 0;
                pMatches.forEach(m => {
                    const isP1 = m.player1Name === p.name;
                    gf += isP1 ? m.player1Goals : m.player2Goals;
                    ga += isP1 ? m.player2Goals : m.player1Goals;
                    if(m.player1Goals === m.player2Goals) draws++;
                    if((isP1 && m.player2Goals === 0) || (!isP1 && m.player1Goals === 0)) cleanSheets++;
                });
                return { name: p.name, played: pMatches.length, gf, ga, draws, cleanSheets, avgTotalGoals: pMatches.length > 0 ? (gf + ga) / pMatches.length : 0, drawPct: pMatches.length > 0 ? (draws/pMatches.length) : 0 };
            });

            const glassCannon = [...playerStats].filter(p => p.played >= 5).sort((a,b) => b.avgTotalGoals - a.avgTotalGoals)[0];
            if(glassCannon && glassCannon.name === currentPlayerName) {
                titlesHTML += `<div class="special-title"><span class="title-icon">🗡️</span><div><p class="font-bold">The Glass Cannon</p><p class="text-sm opacity-70">Highest average goals in matches (for + against).</p></div></div>`;
            }

            const fortress = [...playerStats].filter(p => p.played >= 5).sort((a,b) => b.cleanSheets - a.cleanSheets)[0];
            if(fortress && fortress.name === currentPlayerName && fortress.cleanSheets > 0) {
                 titlesHTML += `<div class="special-title"><span class="title-icon">🏰</span><div><p class="font-bold">The Fortress</p><p class="text-sm opacity-70">Most clean sheets across all leagues.</p></div></div>`;
            }
            
            const pacifist = [...playerStats].filter(p => p.played >= 5).sort((a,b) => b.drawPct - a.drawPct)[0];
            if(pacifist && pacifist.name === currentPlayerName && pacifist.draws > 0) {
                 titlesHTML += `<div class="special-title"><span class="title-icon">🕊️</span><div><p class="font-bold">The Pacifist</p><p class="text-sm opacity-70">Highest percentage of matches ending in a draw.</p></div></div>`;
            }

            const champions = new Set(allHonors.filter(h => h.award === 'Gold Medal').map(h => `${h.playerName}-${h.leagueName}`));
            const wins = allMatches.filter(m => (m.player1Name === currentPlayerName && m.player1Goals > m.player2Goals) || (m.player2Name === currentPlayerName && m.player2Goals > m.player1Goals));
            let isGiantSlayer = false;
            for(const win of wins) {
                const opponent = win.player1Name === currentPlayerName ? win.player2Name : win.player1Name;
                if(champions.has(`${opponent}-${win.league}`)) {
                    isGiantSlayer = true;
                    break;
                }
            }
            if(isGiantSlayer){
                 titlesHTML += `<div class="special-title"><span class="title-icon">👑</span><div><p class="font-bold">The Giant Slayer</p><p class="text-sm opacity-70">Has defeated a reigning league champion.</p></div></div>`;
            }

            specialTitlesEl.innerHTML = titlesHTML || '<p>No special titles earned yet.</p>';
        }

        document.addEventListener('DOMContentLoaded', startApp);
    </script>
</body>
</html>
