<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Profile - FC 2025 League Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 90%;
            margin: 2rem auto;
            padding: 2rem;
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #00b894;
            font-weight: 700;
        }
        .stat-card, .trophy-card {
             background-color: rgba(255, 255, 255, 0.9);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #e9ecef;
            margin-top: 1.5rem;
        }
        .trophy {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        .trophy:last-child {
            border-bottom: none;
        }
        .trophy-icon {
            font-size: 2rem;
            margin-right: 1rem;
        }
        .player-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .player-avatar {
            width: 128px;
            height: 128px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .match-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #dee2e6;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="playerHeader" class="player-header">
             <img id="playerAvatar" src="https://placehold.co/128x128/e9ecef/495057?text=?" alt="Player Avatar" class="player-avatar">
            <h1 id="playerName" class="text-4xl font-extrabold text-center">Loading...</h1>
            <p id="playerEmail" class="text-gray-500"></p>
        </div>
        <p class="text-center mt-4"><a href="index.html" class="text-green-500 hover:underline">‚Üê Back to Main Page</a></p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
            <div class="stat-card">
                <h2 class="text-2xl mb-4">Career Statistics</h2>
                <div id="careerStats" class="grid grid-cols-2 gap-4"></div>
            </div>
            <div class="trophy-card">
                <h2 class="text-2xl mb-4">Trophy Cabinet</h2>
                <div id="trophyCabinet" class="max-h-96 overflow-y-auto"></div>
            </div>
        </div>
        
        <div class="stat-card">
             <h2 class="text-2xl mb-4">Match History</h2>
             <div id="matchHistory" class="max-h-96 overflow-y-auto"></div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBvXdFou9yUlERH-iaICi6JjNChw1rC2O0",
          authDomain: "fun-league-6edd6.firebaseapp.com",
          projectId: "fun-league-6edd6",
          storageBucket: "fun-league-6edd6.appspot.com",
          messagingSenderId: "132854098604",
          appId: "1:132854098604:web:0c0e829ac99624dac38d09",
          measurementId: "G-QJCY28B9HM"
        };
        
        const playerNameEl = document.getElementById('playerName');
        const playerEmailEl = document.getElementById('playerEmail');
        const playerAvatarEl = document.getElementById('playerAvatar');
        const careerStatsEl = document.getElementById('careerStats');
        const trophyCabinetEl = document.getElementById('trophyCabinet');
        const matchHistoryEl = document.getElementById('matchHistory');

        async function startApp() {
            const params = new URLSearchParams(window.location.search);
            const playerName = params.get('player');

            if (!playerName) {
                playerNameEl.textContent = "Player Not Found";
                return;
            }
            playerNameEl.textContent = playerName;

            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);

                // Fetch all necessary data
                const playersSnapshot = await getDocs(query(collection(db, 'players'), where('name', '==', playerName)));
                const matchesSnapshot = await getDocs(query(collection(db, 'matches'), where('status', '==', 'completed')));
                const honorsSnapshot = await getDocs(query(collection(db, 'honors'), where('playerName', '==', playerName)));
                const clubAssignmentsSnapshot = await getDocs(collection(db, 'clubAssignments'));

                const matches = matchesSnapshot.docs.map(doc => doc.data());
                const honors = honorsSnapshot.docs.map(doc => doc.data());
                
                let playerData = {};
                if(!playersSnapshot.empty) {
                    playerData = playersSnapshot.docs[0].data();
                }

                const clubAssignments = {};
                clubAssignmentsSnapshot.forEach(doc => { clubAssignments[doc.id] = doc.data() });

                calculateAndRenderProfile(playerData, matches, honors, clubAssignments);

            } catch (error) {
                console.error("Error loading profile:", error);
                playerNameEl.textContent = "Error loading profile";
            }
        }

        function calculateAndRenderProfile(playerData, allMatches, honors, clubAssignments) {
            const playerName = playerData.name;
            playerEmailEl.textContent = playerData.email || '';
            if (playerData.avatarUrl) {
                playerAvatarEl.src = playerData.avatarUrl;
            }

            const playerMatches = allMatches.filter(m => m.player1Name === playerName || m.player2Name === playerName);
            
            let wins = 0, losses = 0, draws = 0, gf = 0, ga = 0, biggestWin = { diff: 0, score: 'N/A' };
            playerMatches.forEach(m => {
                const isPlayer1 = m.player1Name === playerName;
                const pGoals = isPlayer1 ? m.player1Goals : m.player2Goals;
                const oGoals = isPlayer1 ? m.player2Goals : m.player1Goals;
                gf += pGoals; ga += oGoals;
                if (pGoals > oGoals) {
                    wins++;
                    if (pGoals - oGoals > biggestWin.diff) biggestWin = { diff: pGoals - oGoals, score: `${pGoals} - ${oGoals}` };
                }
                else if (oGoals > pGoals) losses++;
                else draws++;
            });
            const played = playerMatches.length;
            const winRate = played ? ((wins / played) * 100).toFixed(1) : 0;
            const gpg = played ? (gf / played).toFixed(2) : 0;

            careerStatsEl.innerHTML = `
                <p><strong>Win Rate:</strong> ${winRate}%</p><p><strong>Played:</strong> ${played}</p>
                <p><strong>Record (W-D-L):</strong> ${wins}-${draws}-${losses}</p><p><strong>Goals per Game:</strong> ${gpg}</p>
                <p><strong>Goals For:</strong> ${gf}</p><p><strong>Goals Against:</strong> ${ga}</p>
                <p><strong>Biggest Win:</strong> ${biggestWin.score}</p>
            `;

            const awardIcons = {
                'Gold Medal': 'ü•á',
                'Silver Medal': 'ü•à',
                'Bronze Medal': 'ü•â',
                'Top Scorer': '‚öΩ',
                'Best Defender': 'üõ°Ô∏è'
            };

            trophyCabinetEl.innerHTML = honors.sort((a,b) => b.timestamp - a.timestamp).map(honor => {
                const date = honor.leagueDate ? new Date(honor.leagueDate).toLocaleDateString() : new Date(honor.timestamp).toLocaleDateString();
                return `
                <div class="trophy">
                    <span class="trophy-icon">${awardIcons[honor.award] || 'üèÜ'}</span>
                    <div>
                        <p class="font-bold">${honor.award}</p>
                        <p class="text-sm text-gray-500">${honor.leagueName} (${date})</p>
                    </div>
                </div>`
            }).join('') || '<p>No honors earned yet.</p>';
            
            matchHistoryEl.innerHTML = playerMatches.sort((a,b) => b.timestamp
