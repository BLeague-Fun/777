<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Profile - Fifa Leagues Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; color: #333; }
        .container { max-width: 90%; margin: 2rem auto; padding: 2rem; background-color: rgba(255, 255, 255, 0.85); border-radius: 1rem; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #00b894; font-weight: 700; }
        .stat-card, .trophy-card, .title-card {
             background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #e9ecef;
            margin-top: 1.5rem;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
         .stat-card:hover, .trophy-card:hover, .title-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
        }
        .trophy, .special-title { display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef; }
        .trophy:last-child, .special-title:last-child { border-bottom: none; }
        .trophy-icon, .title-icon { font-size: 2rem; margin-right: 1rem; }
        .player-header {
            background-color: #fff;
            border-radius: 0.75rem;
            padding: 2rem;
            border: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            background-image: url('https://www.transparenttextures.com/patterns/light-sketch.png');
        }
        .player-avatar {
            width: 128px;
            height: 128px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #00b894;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 1rem;
        }
        .match-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #dee2e6; }
        .favorite-club-card { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .favorite-club-logo { max-height: 80px; margin-bottom: 0.5rem; }
        .loading-placeholder { filter: blur(4px); transition: filter 0.3s; }
        .loaded { filter: blur(0); }
    </style>
</head>
<body>

    <div class="container">
        <div id="playerHeader" class="player-header">
             <img id="playerAvatar" src="https://placehold.co/128x128/e9ecef/495057?text=?" alt="Player Avatar" class="player-avatar">
            <h1 id="playerName" class="text-4xl font-extrabold text-center">Loading...</h1>
            <p id="playerEmail" class="opacity-70"></p>
            <div id="favoriteClub" class="mt-4"></div>
        </div>
        <p class="text-center mt-4"><a href="index.html" class="text-green-500 hover:underline">‚Üê Back to Main Page</a></p>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
            <div class="stat-card md:col-span-2">
                <h2 class="text-2xl mb-4 text-center">Career Statistics</h2>
                <div id="careerStats" class="grid grid-cols-2 gap-4 loading-placeholder"><p class="col-span-2 text-center">Calculating stats...</p></div>
            </div>
            <div class="trophy-card">
                <h2 class="text-2xl mb-4 text-center">Trophy Cabinet</h2>
                <div id="trophyCabinet" class="max-h-[300px] overflow-y-auto"><p class="text-center">Loading trophies...</p></div>
            </div>
             <div class="title-card md:col-span-3">
                <h2 class="text-2xl mb-4 text-center">Special Titles</h2>
                <div id="specialTitles" class="max-h-96 overflow-y-auto loading-placeholder"><p class="text-center">Analyzing performance...</p></div>
            </div>
        </div>
        
        <div class="stat-card">
             <h2 class="text-2xl mb-4 text-center">Match History</h2>
             <div id="matchHistory" class="max-h-96 overflow-y-auto loading-placeholder"><p class="text-center">Loading matches...</p></div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBvXdFou9yUlERH-iaICi6JjNChw1rC2O0",
          authDomain: "fun-league-6edd6.firebaseapp.com",
          projectId: "fun-league-6edd6",
          storageBucket: "fun-league-6edd6.appspot.com",
          messagingSenderId: "132854098604",
          appId: "1:132854098604:web:0c0e829ac99624dac38d09",
          measurementId: "G-QJCY28B9HM"
        };
        
        const playerNameEl = document.getElementById('playerName');
        const playerEmailEl = document.getElementById('playerEmail');
        const playerAvatarEl = document.getElementById('playerAvatar');
        const careerStatsEl = document.getElementById('careerStats');
        const trophyCabinetEl = document.getElementById('trophyCabinet');
        const specialTitlesEl = document.getElementById('specialTitles');
        const matchHistoryEl = document.getElementById('matchHistory');
        const favoriteClubEl = document.getElementById('favoriteClub');

        async function startApp() {
            const params = new URLSearchParams(window.location.search);
            const playerName = params.get('player');

            if (!playerName) {
                playerNameEl.textContent = "Player Not Found";
                return;
            }
            playerNameEl.textContent = playerName;

            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                await signInAnonymously(auth); 
                const db = getFirestore(app);

                // Quick initial render
                const playersSnapshot = await getDocs(query(collection(db, 'players'), where('name', '==', playerName)));
                let playerData = {};
                if(!playersSnapshot.empty) {
                    playerData = playersSnapshot.docs[0].data();
                }
                const honorsSnapshot = await getDocs(query(collection(db, 'honors'), where('playerName', '==', playerName)));
                const honors = honorsSnapshot.docs.map(doc => doc.data());
                
                renderPrimaryInfo(playerData, honors);
                
                // Fetch heavier data async
                const allPlayersSnapshot = await getDocs(collection(db, 'players'));
                const matchesSnapshot = await getDocs(query(collection(db, 'matches'), where('status', '==', 'completed')));
                const clubAssignmentsSnapshot = await getDocs(collection(db, 'clubAssignments'));
                const clubsSnapshot = await getDocs(collection(db, 'clubs'));

                const allPlayers = allPlayersSnapshot.docs.map(doc => doc.data());
                const allMatches = matchesSnapshot.docs.map(doc => doc.data());
                const clubs = clubsSnapshot.docs.map(doc => doc.data());
                const clubAssignments = {};
                clubAssignmentsSnapshot.forEach(doc => { clubAssignments[doc.id] = doc.data() });

                renderSecondaryInfo(playerData, allPlayers, allMatches, honors, clubAssignments, clubs);

            } catch (error) {
                console.error("Error loading profile:", error);
                playerNameEl.textContent = "Error loading profile";
            }
        }
        
        function renderPrimaryInfo(playerData, honors) {
            playerEmailEl.textContent = playerData.email || '';
            if (playerData.avatarUrl) {
                playerAvatarEl.src = playerData.avatarUrl;
            }

            const awardIcons = {
                'Gold Medal': 'ü•á', 'Silver Medal': 'ü•à', 'Bronze Medal': 'ü•â',
                'Top Scorer': '‚öΩ', 'Best Defender': 'üõ°Ô∏è'
            };

            trophyCabinetEl.innerHTML = honors.sort((a,b) => b.timestamp - a.timestamp).map(honor => {
                const date = honor.leagueDate ? new Date(honor.leagueDate).toLocaleDateString() : new Date(honor.timestamp).toLocaleDateString();
                return `<div class="trophy"><span class="trophy-icon">${awardIcons[honor.award] || 'üèÜ'}</span><div><p class="font-bold">${honor.award}</p><p class="text-sm opacity-70">${honor.leagueName} (${date})</p></div></div>`
            }).join('') || '<p>No honors earned yet.</p>';
        }

        function renderSecondaryInfo(playerData, allPlayers, allMatches, allHonors, clubAssignments, allClubs) {
            const playerName = playerData.name;

            const favoriteClubName = playerData.favoriteClub;
            const favoriteClubData = allClubs.find(c => c.name === favoriteClubName);
            if (favoriteClubData) {
                favoriteClubEl.innerHTML = `
                    <img src="${favoriteClubData.logoUrl}" alt="${favoriteClubData.name}" class="favorite-club-logo">
                    <p class="font-bold">${favoriteClubData.name}</p>
                `;
            } else {
                 favoriteClubEl.innerHTML = `<p class="text-sm">No favorite club selected.</p>`;
            }

            const playerMatches = allMatches.filter(m => m.player1Name === playerName || m.player2Name === playerName);
            
            let wins = 0, losses = 0, draws = 0, gf = 0, ga = 0, biggestWin = { diff: 0, score: 'N/A' };
            let worstLoss = { diff: 0, score: 'N/A' };
            const lossesTo = {};
            const winsAgainst = {};

            playerMatches.forEach(m => {
                const isPlayer1 = m.player1Name === playerName;
                const pGoals = isPlayer1 ? m.player1Goals : m.player2Goals;
                const oGoals = isPlayer1 ? m.player2Goals : m.player1Goals;
                const opponentName = isPlayer1 ? m.player2Name : m.player1Name;

                gf += pGoals; ga += oGoals;
                
                if (pGoals > oGoals) {
                    wins++;
                    winsAgainst[opponentName] = (winsAgainst[opponentName] || 0) + 1;
                    if (pGoals - oGoals > biggestWin.diff) biggestWin = { diff: pGoals - oGoals, score: `${pGoals} - ${oGoals}` };
                } else if (oGoals > pGoals) {
                    losses++;
                    lossesTo[opponentName] = (lossesTo[opponentName] || 0) + 1;
                    if (oGoals - pGoals > worstLoss.diff) worstLoss = { diff: oGoals - pGoals, score: `${pGoals} - ${oGoals}` };
                } else {
                    draws++;
                }
            });
            
            const played = playerMatches.length;
            const winRate = played ? ((wins / played) * 100).toFixed(1) : 0;
            const gpg = played ? (gf / played).toFixed(2) : 0;
            
            let nemesisName = 'None', maxLosses = 0;
            for (const opponent in lossesTo) {
                if (lossesTo[opponent] > maxLosses) {
                    maxLosses = lossesTo[opponent];
                    nemesisName = opponent;
                }
            }

            let favoriteOpponent = 'None', maxWins = 0;
             for (const opponent in winsAgainst) {
                if (winsAgainst[opponent] > maxWins) {
                    maxWins = winsAgainst[opponent];
                    favoriteOpponent = opponent;
                }
            }

            careerStatsEl.innerHTML = `
                <p><strong>Win Rate:</strong> ${winRate}%</p><p><strong>Played:</strong> ${played}</p>
                <p><strong>Record (W-D-L):</strong> ${wins}-${draws}-${losses}</p><p><strong>Goals per Game:</strong> ${gpg}</p>
                <p><strong>Goals For:</strong> ${gf}</p><p><strong>Goals Against:</strong> ${ga}</p>
                <p><strong>Biggest Win:</strong> ${biggestWin.score}</p>
                <p><strong>Crushing Defeat:</strong> ${worstLoss.score}</p>
                <p class="col-span-2"><strong>Nemesis:</strong> ${nemesisName === 'None' ? 'None' : `${nemesisName} (${maxLosses} losses)`}</p>
                 <p class="col-span-2"><strong>Favorite Opponent:</strong> ${favoriteOpponent === 'None' ? 'None' : `${favoriteOpponent} (${maxWins} wins)`}</p>
            `;
            careerStatsEl.classList.remove('loading-placeholder');

            renderSpecialTitles(playerName, allPlayers, allMatches, allHonors);
            
            matchHistoryEl.innerHTML = playerMatches.sort((a,b) => b.timestamp - a.timestamp).map(m => {
                 const p1Club = clubAssignments[m.league]?.[m.player1Name] || '';
                 const p2Club = clubAssignments[m.league]?.[m.player2Name] || '';
                 return `<div class="match-item"><span>${m.league}: ${m.player1Name} ${p1Club ? `(${p1Club})` : ''} <b>${m.player1Goals}</b> - <b>${m.player2Goals}</b> ${m.player2Name} ${p2Club ? `(${p2Club})` : ''}</span></div>`
             }).join('') || '<p>No matches played.</p>';
            matchHistoryEl.classList.remove('loading-placeholder');
        }

        function renderSpecialTitles(currentPlayerName, allPlayers, allMatches, allHonors) {
            let titlesHTML = '';
            const playerStats = allPlayers.map(p => {
                const pMatches = allMatches.filter(m => m.player1Name === p.name || m.player2Name === p.name);
                let gf = 0, ga = 0, draws = 0, cleanSheets = 0;
                pMatches.forEach(m => {
                    const isP1 = m.player1Name === p.name;
                    gf += isP1 ? m.player1Goals : m.player2Goals;
                    ga += isP1 ? m.player2Goals : m.player1Goals;
                    if(m.player1Goals === m.player2Goals) draws++;
                    if((isP1 && m.player2Goals === 0) || (!isP1 && m.player1Goals === 0)) cleanSheets++;
                });
                return { name: p.name, played: pMatches.length, gf, ga, draws, cleanSheets, avgTotalGoals: pMatches.length > 0 ? (gf + ga) / pMatches.length : 0, drawPct: pMatches.length > 0 ? (draws/pMatches.length) : 0 };
            });

            const glassCannon = [...playerStats].filter(p => p.played >= 5).sort((a,b) => b.avgTotalGoals - a.avgTotalGoals)[0];
            if(glassCannon && glassCannon.name === currentPlayerName) {
                titlesHTML += `<div class="special-title"><span class="title-icon">üó°Ô∏è</span><div><p class="font-bold">The Glass Cannon</p><p class="text-sm opacity-70">Highest average goals in matches (for + against).</p></div></div>`;
            }

            const fortress = [...playerStats].filter(p => p.played >= 5).sort((a,b) => b.cleanSheets - a.cleanSheets)[0];
            if(fortress && fortress.name === currentPlayerName && fortress.cleanSheets > 0) {
                 titlesHTML += `<div class="special-title"><span class="title-icon">üè∞</span><div><p class="font-bold">The Fortress</p><p class="text-sm opacity-70">Most clean sheets across all leagues.</p></div></div>`;
            }
            
            const pacifist = [...playerStats].filter(p => p.played >= 5).sort((a,b) => b.drawPct - a.drawPct)[0];
            if(pacifist && pacifist.name === currentPlayerName && pacifist.draws > 0) {
                 titlesHTML += `<div class="special-title"><span class="title-icon">üïäÔ∏è</span><div><p class="font-bold">The Pacifist</p><p class="text-sm opacity-70">Highest percentage of matches ending in a draw.</p></div></div>`;
            }

            const champions = new Set(allHonors.filter(h => h.award === 'Gold Medal').map(h => `${h.playerName}-${h.leagueName}`));
            const wins = allMatches.filter(m => (m.player1Name === currentPlayerName && m.player1Goals > m.player2Goals) || (m.player2Name === currentPlayerName && m.player2Goals > m.player1Goals));
            let isGiantSlayer = false;
            for(const win of wins) {
                const opponent = win.player1Name === currentPlayerName ? win.player2Name : win.player1Name;
                if(champions.has(`${opponent}-${win.league}`)) {
                    isGiantSlayer = true;
                    break;
                }
            }
            if(isGiantSlayer){
                 titlesHTML += `<div class="special-title"><span class="title-icon">üëë</span><div><p class="font-bold">The Giant Slayer</p><p class="text-sm opacity-70">Has defeated a reigning league champion.</p></div></div>`;
            }

            specialTitlesEl.innerHTML = titlesHTML || '<p>No special titles earned yet.</p>';
            specialTitlesEl.classList.remove('loading-placeholder');
        }

        document.addEventListener('DOMContentLoaded', startApp);
    </script>
</body>
</html>

