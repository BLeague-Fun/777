<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FC 2025 League Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');
        
        :root {
            --bg-color-dark: #0d1117;
            --container-bg-dark: rgba(22, 27, 34, 0.85);
            --section-bg-dark: rgba(13, 17, 23, 0.9);
            --border-color-dark: #30363d;
            --text-primary-dark: #c9d1d9;
            --text-secondary-dark: #8b949e;
            --accent-color-dark: #58a6ff;

            --bg-color-light: #f0f2f5;
            --container-bg-light: rgba(255, 255, 255, 0.85);
            --section-bg-light: rgba(240, 242, 245, 0.9);
            --border-color-light: #d0d7de;
            --text-primary-light: #24292f;
            --text-secondary-light: #57606a;
            --accent-color-light: #0969da;
        }

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Dark Theme */
        body.dark-theme {
            background-color: var(--bg-color-dark);
            color: var(--text-primary-dark);
        }
        .dark-theme .container { background-color: var(--container-bg-dark); }
        .dark-theme .form-section, .dark-theme .standings-section, .dark-theme .archive-section, .dark-theme .stats-section {
            background-color: var(--section-bg-dark);
            border-color: var(--border-color-dark);
        }
        .dark-theme h1, .dark-theme h2 { color: var(--accent-color-dark); }
        .dark-theme input, .dark-theme button, .dark-theme select {
            border-color: var(--border-color-dark);
            background-color: #010409;
            color: var(--text-primary-dark);
        }
        .dark-theme th { background-color: #1f2730; }
        .dark-theme .tab-button, .dark-theme .league-tab-button { background-color: #30363d; border-color: #30363d; }
        .dark-theme .tab-button.active, .dark-theme .league-tab-button.active { background-color: var(--section-bg-dark); border-bottom-color: var(--section-bg-dark); }
        .dark-theme .player-name-link { color: var(--accent-color-dark); }
        .dark-theme .modal-content { background-color: #161b22; border-color: var(--border-color-dark); }
        .dark-theme ::-webkit-scrollbar-thumb { background: #555; }
        .dark-theme ::-webkit-scrollbar-track { background: #333; }

        /* Light Theme */
        body.light-theme {
            background-color: var(--bg-color-light);
            color: var(--text-primary-light);
        }
        .light-theme .container { background-color: var(--container-bg-light); }
        .light-theme .form-section, .light-theme .standings-section, .light-theme .archive-section, .light-theme .stats-section {
            background-color: var(--section-bg-light);
            border-color: var(--border-color-light);
        }
        .light-theme h1, .light-theme h2 { color: var(--accent-color-light); }
        .light-theme input, .light-theme button, .light-theme select {
            border-color: var(--border-color-light);
            background-color: #f6f8fa;
            color: var(--text-primary-light);
        }
        .light-theme button { background-color: #2c974b; }
        .light-theme button:hover { background-color: #298e46; }
        .light-theme th { background-color: #f6f8fa; color: var(--text-primary-light); }
        .light-theme tr:hover { background-color: #f6f8fa; }
        .light-theme .tab-button, .light-theme .league-tab-button { background-color: #e1e4e8; border-color: #d0d7de; color: var(--text-primary-light); }
        .light-theme .tab-button.active, .light-theme .league-tab-button.active { background-color: var(--section-bg-light); border-bottom-color: var(--section-bg-light); }
        .light-theme .player-name-link { color: var(--accent-color-light); }
        .light-theme .modal-content { background-color: #ffffff; border-color: var(--border-color-light); }
        .light-theme ::-webkit-scrollbar-thumb { background: #bbb; }
        .light-theme ::-webkit-scrollbar-track { background: #eee; }

        /* Glassmorphism & General Styles */
        .container {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .form-section, .standings-section, .archive-section, .stats-section {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        h2 .icon {
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
            width: 1.5rem;
            height: 1.5rem;
        }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; overflow-y: auto;
        }
        .modal-content {
            padding: 2rem; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%; max-width: 600px;
        }
        .match-item, .player-item, .league-item {
            display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);
        }
        .hidden { display: none; }
        .rank-gold { background-color: rgba(255, 215, 0, 0.15); }
        .rank-silver { background-color: rgba(192, 192, 192, 0.15); }
        .rank-bronze { background-color: rgba(205, 127, 50, 0.15); }
        .player-name-link { cursor: pointer; text-decoration: underline; }
        .match-of-the-week-item { background-color: rgba(255, 215, 0, 0.1); border-left: 3px solid #ffd700; }
        .star-btn { color: #6e7681; cursor: pointer; } .star-btn.active { color: #ffd700; }
        #motwContainer {
            border: 1px solid #ffd700;
            background: linear-gradient(145deg, rgba(255, 215, 0, 0.05), rgba(255, 215, 0, 0.15));
        }
        #theme-toggle-button {
            position: absolute; top: 2.5rem; right: 2.5rem; cursor: pointer;
            background: none; border: none; padding: 0.5rem;
        }
        #theme-toggle-button svg { width: 24px; height: 24px; }
        .light-theme #theme-toggle-button #moon-icon { display: block; }
        .light-theme #theme-toggle-button #sun-icon { display: none; }
        .dark-theme #theme-toggle-button #moon-icon { display: none; }
        .dark-theme #theme-toggle-button #sun-icon { display: block; }
        ::-webkit-scrollbar { width: 8px; }
    </style>
</head>
<body>

    <div class="container relative">
        <button id="theme-toggle-button" title="Toggle theme">
             <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-yellow-400">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12h2.25m.386-6.364l1.591 1.591" />
            </svg>
            <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-700">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
            </svg>
        </button>
        <h1 class="text-4xl font-extrabold">FC 2025 League Tracker</h1>
        <p class="text-center text-sm mt-2"><span id="userIdDisplay">Loading...</span></p>

        <div id="hero-section" class="stats-section mt-6 hidden"></div>

        <div class="tab-buttons">
            <button id="matchesTabButton" class="tab-button active">Matches</button>
            <button id="adminTabButton" class="tab-button hidden">Admin</button>
        </div>
        
        <div id="matchesTab" class="tab-content">
            <div id="motwContainer" class="stats-section hidden"></div>
            <div id="leagueTabsContainer" class="league-tabs-container"></div>
            <div id="leagueContentContainer"></div>

             <div class="stats-section">
                <h2 class="text-2xl mb-4"><span class="icon">‚öîÔ∏è</span>Head-to-Head</h2>
                <div class="flex items-center gap-4">
                    <select id="h2hPlayer1Select" class="w-full"></select>
                    <span class="font-bold">vs</span>
                    <select id="h2hPlayer2Select" class="w-full"></select>
                    <button id="h2hButton" class="bg-blue-600 hover:bg-blue-500">Compare</button>
                </div>
                <div id="h2hResult" class="mt-4 text-center"></div>
            </div>

            <div class="archive-section">
                <h2 class="text-2xl mb-4"><span class="icon">üìú</span>Match Archive</h2>
                <div id="matchList"></div>
            </div>
        </div>

        <div id="adminTab" class="tab-content hidden">
            <!-- Admin content remains the same -->
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <p id="modalText"></p>
            <div class="modal-buttons">
                <button id="cancelDeleteButton" class="bg-gray-700 hover:bg-gray-600">Cancel</button>
                <button id="confirmDeleteButton" class="confirm">Delete</button>
            </div>
        </div>
    </div>

    <div id="playerProfileModal" class="modal">
         <div id="playerProfileContent" class="modal-content"></div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, updateDoc, onSnapshot, collection, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyBvXdFou9yUlERH-iaICi6JjNChw1rC2O0",
          authDomain: "fun-league-6edd6.firebaseapp.com",
          projectId: "fun-league-6edd6",
          storageBucket: "fun-league-6edd6.appspot.com",
          messagingSenderId: "132854098604",
          appId: "1:132854098604:web:0c0e829ac99624dac38d09",
          measurementId: "G-QJCY28B9HM"
        };
        
        const adminUID = "7ss4Z12tDkgCQB1pevK6gKR1WpI3";

        // DOM element references
        const heroSection = document.getElementById('hero-section');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const motwContainer = document.getElementById('motwContainer');
        const matchList = document.getElementById('matchList');
        const confirmationModal = document.getElementById('confirmationModal');
        const playerProfileModal = document.getElementById('playerProfileModal');
        const playerProfileContent = document.getElementById('playerProfileContent');
        const h2hPlayer1Select = document.getElementById('h2hPlayer1Select');
        const h2hPlayer2Select = document.getElementById('h2hPlayer2Select');
        const h2hButton = document.getElementById('h2hButton');
        const h2hResult = document.getElementById('h2hResult');
        const leagueTabsContainer = document.getElementById('leagueTabsContainer');
        const leagueContentContainer = document.getElementById('leagueContentContainer');
        const addMatchForm = document.getElementById('addMatchForm');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        const player1Select = document.getElementById('player1Select');
        const player2Select = document.getElementById('player2Select');
        const leagueSelect = document.getElementById('leagueSelect');
        const addPlayerForm = document.getElementById('addPlayerForm');
        const addLeagueForm = document.getElementById('addLeagueForm');
        const playerListContainer = document.getElementById('playerList');
        const leagueListContainer = document.getElementById('leagueList');
        const modalText = document.getElementById('modalText');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const matchesTabButton = document.getElementById('matchesTabButton');
        const adminTabButton = document.getElementById('adminTabButton');
        
        let db, auth, userId;
        let itemToDelete = null;
        let players = [], leagues = [], matches = [];
        let chartInstances = {};
        const chartColors = ['#58a6ff', '#238636', '#e54848', '#a371f7', '#f25757', '#2ea043'];

        // Theme switcher logic
        function applyTheme(theme) {
            document.body.className = theme;
            localStorage.setItem('theme', theme);
            Object.values(chartInstances).forEach(chart => {
                const isDark = theme === 'dark-theme';
                chart.options.scales.y.ticks.color = isDark ? '#c9d1d9' : '#24292f';
                chart.options.scales.x.ticks.color = isDark ? '#c9d1d9' : '#24292f';
                chart.options.plugins.legend.labels.color = isDark ? '#c9d1d9' : '#24292f';
                chart.update();
            });
        }
        themeToggleButton.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('dark-theme') ? 'light-theme' : 'dark-theme';
            applyTheme(newTheme);
        });

        async function startApp() {
            try {
                const preferredTheme = localStorage.getItem('theme') || 'dark-theme';
                applyTheme(preferredTheme);

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                auth.onAuthStateChanged(user => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        adminTabButton.classList.toggle('hidden', userId !== adminUID);
                        setupListeners();
                    } else {
                        userIdDisplay.textContent = "Signed Out";
                        adminTabButton.classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                userIdDisplay.textContent = "Error";
            }
        }
        
        function setupListeners() {
            onSnapshot(collection(db, 'players'), snapshot => {
                players = snapshot.docs.map(doc => doc.data().name);
                renderPlayerLists();
                renderAllLeagueData();
            });
            onSnapshot(collection(db, 'leagues'), snapshot => {
                leagues = snapshot.docs.map(doc => doc.data().name);
                renderLeagueLists();
                renderAllLeagueData();
            });
            onSnapshot(query(collection(db, 'matches')), snapshot => {
                matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMatchList();
                renderAllLeagueData();
                renderMOTW();
            });
        }

        function renderAllLeagueData() {
            if (!leagues.length) return;
            const activeLeague = document.querySelector('.league-tab-button.active')?.dataset.league || leagues[0];
            leagueTabsContainer.innerHTML = '';
            leagueContentContainer.innerHTML = '';
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};
            
            let firstLeagueStandings = [];

            leagues.forEach((league, leagueIndex) => {
                const tabButton = document.createElement('button');
                tabButton.className = 'league-tab-button';
                tabButton.textContent = league;
                tabButton.dataset.league = league;
                if (league === activeLeague) tabButton.classList.add('active');
                tabButton.onclick = () => switchLeagueTab(league);
                leagueTabsContainer.appendChild(tabButton);

                const contentDiv = document.createElement('div');
                contentDiv.id = `content-${league}`;
                contentDiv.className = 'league-content';
                if (league !== activeLeague) contentDiv.classList.add('hidden');
                
                const leagueMatches = matches.filter(m => m.league === league).sort((a,b) => a.timestamp - b.timestamp);
                const leaguePlayers = [...new Set(leagueMatches.flatMap(m => [m.player1Name, m.player2Name]))];
                
                const standings = calculateLeagueStats(leagueMatches, leaguePlayers);
                if (leagueIndex === 0) firstLeagueStandings = standings;
                contentDiv.innerHTML += generateStandingsHTML(league, standings);
                
                const { topScorers, topDefenders } = calculateTopPlayers(leagueMatches, leaguePlayers);
                contentDiv.innerHTML += generateTopPlayersHTML(topScorers, topDefenders);

                const chartData = calculatePlayerProgress(leagueMatches, leaguePlayers);
                contentDiv.innerHTML += `<div class="stats-section"><h2 class="text-2xl mb-4"><span class="icon">üìà</span>Points Progression</h2><canvas id="chart-${league}"></canvas></div>`;

                leagueContentContainer.appendChild(contentDiv);
                
                if (chartData.datasets.length > 0) {
                    renderChart(league, chartData);
                }
            });
            renderHeroSection(firstLeagueStandings);
            updateH2HDropdowns();
        }
        
        function renderHeroSection(standings) {
            if(standings.length > 0) {
                const leader = standings[0];
                heroSection.innerHTML = `
                    <h2 class="text-2xl text-center text-yellow-400 font-bold">üëë League Leader üëë</h2>
                    <p class="text-4xl text-center font-extrabold mt-2">${leader.player}</p>
                    <p class="text-center text-xl mt-1">${leader.points} Points</p>
                `;
                heroSection.classList.remove('hidden');
            } else {
                heroSection.classList.add('hidden');
            }
        }

        function switchLeagueTab(leagueName) {
            document.querySelectorAll('.league-tab-button').forEach(btn => btn.classList.toggle('active', btn.dataset.league === leagueName));
            document.querySelectorAll('.league-content').forEach(content => content.classList.toggle('hidden', content.id !== `content-${leagueName}`));
            updateH2HDropdowns();
        }

        function calculateLeagueStats(leagueMatches, leaguePlayers) {
            const stats = {};
            leaguePlayers.forEach(p => {
                stats[p] = { player: p, played: 0, wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, gd: 0, points: 0 };
            });
            leagueMatches.forEach(m => {
                const s1 = stats[m.player1Name], s2 = stats[m.player2Name];
                if (!s1 || !s2) return;
                s1.played++; s2.played++;
                s1.gf += m.player1Goals; s1.ga += m.player2Goals;
                s2.gf += m.player2Goals; s2.ga += m.player1Goals;
                s1.gd = s1.gf - s1.ga; s2.gd = s2.gf - s2.ga;

                if (m.player1Goals > m.player2Goals) { s1.wins++; s1.points += 3; s2.losses++; }
                else if (m.player2Goals > m.player1Goals) { s2.wins++; s2.points += 3; s1.losses++; }
                else { s1.draws++; s1.points++; s2.draws++; s2.points++; }
            });
            return Object.values(stats).sort((a, b) => b.points - a.points || b.gd - a.gd || b.gf - a.gf);
        }

        function getRankClass(index) {
            if (index === 0) return 'rank-gold';
            if (index === 1) return 'rank-silver';
            if (index === 2) return 'rank-bronze';
            return '';
        }

        function generateStandingsHTML(leagueName, standings) {
             if (standings.length === 0) return `<div class="standings-section"><h2 class="text-2xl"><span class="icon">üèÜ</span>${leagueName} Standings</h2><p>No matches played yet in this league.</p></div>`;
             return `<div class="standings-section">
                <h2 class="text-2xl mb-4"><span class="icon">üèÜ</span>${leagueName} Standings</h2>
                <table class="w-full"><thead><tr>
                    <th>Rank</th><th>Player</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th>
                </tr></thead><tbody>
                ${standings.map((p, i) => `
                    <tr class="${getRankClass(i)}">
                        <td>${i + 1}</td><td class="player-name-link" data-player-name="${p.player}">${p.player}</td><td>${p.played}</td><td>${p.wins}</td>
                        <td>${p.draws}</td><td>${p.losses}</td><td>${p.gf}</td>
                        <td>${p.ga}</td><td>${p.gd}</td><td class="font-bold">${p.points}</td>
                    </tr>`).join('')}
                </tbody></table></div>`;
        }

        function calculatePlayerProgress(leagueMatches, leaguePlayers) {
            const progressData = { labels: [], datasets: [] };
            let maxGames = 0;
            leaguePlayers.forEach((player, index) => {
                const playerMatches = leagueMatches.filter(m => m.player1Name === player || m.player2Name === player);
                if (playerMatches.length === 0) return;
                let currentPoints = 0;
                const pointsHistory = [0];
                playerMatches.forEach(m => {
                    const isPlayer1 = m.player1Name === player;
                    const pGoals = isPlayer1 ? m.player1Goals : m.player2Goals;
                    const oGoals = isPlayer1 ? m.player2Goals : m.player1Goals;
                    if (pGoals > oGoals) currentPoints += 3;
                    else if (pGoals === oGoals) currentPoints += 1;
                    pointsHistory.push(currentPoints);
                });
                progressData.datasets.push({
                    label: player, data: pointsHistory,
                    borderColor: chartColors[index % chartColors.length],
                    backgroundColor: chartColors[index % chartColors.length] + '33',
                    fill: false, tension: 0.1
                });
                if (playerMatches.length > maxGames) maxGames = playerMatches.length;
            });
            progressData.labels = Array.from({ length: maxGames + 1 }, (_, i) => `Game ${i}`);
            return progressData;
        }

        function renderChart(leagueName, chartData) {
            const ctx = document.getElementById(`chart-${leagueName}`)?.getContext('2d');
            if(!ctx) return;
            const isDark = document.body.classList.contains('dark-theme');
            chartInstances[leagueName] = new Chart(ctx, {
                type: 'line', data: chartData,
                options: {
                    scales: { 
                        y: { beginAtZero: true, ticks: { color: isDark ? '#c9d1d9' : '#24292f' }, grid: { color: isDark ? '#30363d' : '#d0d7de'} }, 
                        x: { ticks: { color: isDark ? '#c9d1d9' : '#24292f' }, grid: { color: isDark ? '#30363d' : '#d0d7de'} } 
                    },
                    plugins: { legend: { labels: { color: isDark ? '#c9d1d9' : '#24292f' } } }
                }
            });
        }
        
        function calculateTopPlayers(leagueMatches, leaguePlayers) {
            const stats = {};
            leaguePlayers.forEach(p => { stats[p] = { player: p, played: 0, gf: 0, ga: 0 }; });
            leagueMatches.forEach(m => {
                stats[m.player1Name].played++; stats[m.player2Name].played++;
                stats[m.player1Name].gf += m.player1Goals; stats[m.player1Name].ga += m.player2Goals;
                stats[m.player2Name].gf += m.player2Goals; stats[m.player2Name].ga += m.player1Goals;
            });
            const allStats = Object.values(stats).filter(p => p.played > 0);
            const topScorers = [...allStats].sort((a,b) => b.gf - a.gf).slice(0, 3);
            const topDefenders = [...allStats].sort((a,b) => a.ga - b.ga).slice(0, 3);
            return { topScorers, topDefenders };
        }
        
        function generateTopPlayersHTML(topScorers, topDefenders) {
             return `<div class="flex flex-col md:flex-row gap-4">
                <div class="stats-section flex-1">
                    <h2 class="text-2xl mb-4"><span class="icon">‚öΩ</span>Top Goal Scorers</h2>
                    <table><thead><tr><th>Rank</th><th>Player</th><th>Goals</th></tr></thead><tbody>
                        ${topScorers.map((p, i) => `<tr><td>${i+1}</td><td class="player-name-link" data-player-name="${p.player}">${p.player}</td><td class="font-bold">${p.gf}</td></tr>`).join('')}
                    </tbody></table>
                </div>
                <div class="stats-section flex-1">
                    <h2 class="text-2xl mb-4"><span class="icon">üõ°Ô∏è</span>Top Defenders</h2>
                    <table><thead><tr><th>Rank</th><th>Player</th><th>Goals Against</th></tr></thead><tbody>
                        ${topDefenders.map((p, i) => `<tr><td>${i+1}</td><td class="player-name-link" data-player-name="${p.player}">${p.player}</td><td class="font-bold">${p.ga}</td></tr>`).join('')}
                    </tbody></table>
                </div>
            </div>`;
        }

        function renderMOTW() {
            const motw = matches.find(m => m.isMOTW);
            if(motw) {
                motwContainer.innerHTML = `
                    <h2 class="text-2xl mb-2 text-center text-yellow-400">‚òÖ Match of the Week ‚òÖ</h2>
                    <div class="text-center">
                        <p class="text-lg">${motw.league}</p>
                        <p class="text-3xl font-bold my-2">
                            <span class="player-name-link" data-player-name="${motw.player1Name}">${motw.player1Name}</span>
                            <span class="mx-4">${motw.player1Goals} - ${motw.player2Goals}</span>
                            <span class="player-name-link" data-player-name="${motw.player2Name}">${motw.player2Name}</span>
                        </p>
                    </div>`;
                motwContainer.classList.remove('hidden');
            } else {
                motwContainer.classList.add('hidden');
            }
        }

        function renderMatchList() {
            const isAdmin = userId === adminUID;
            matchList.innerHTML = [...matches].sort((a,b) => b.timestamp - a.timestamp).map(m => `
                <div class="match-item ${m.isMOTW ? 'match-of-the-week-item' : ''}">
                    <span>${m.league}: ${m.player1Name} <b>${m.player1Goals}</b> - <b>${m.player2Goals}</b> ${m.player2Name}</span>
                    <div class="flex items-center">
                        ${isAdmin ? `<button class="star-btn ${m.isMOTW ? 'active' : ''}" data-id="${m.id}" title="Match of the Week">‚òÖ</button>` : ''}
                        ${isAdmin ? `<button data-id="${m.id}" data-type="match" class="delete-item-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>` : ''}
                    </div>
                </div>`).join('') || '<p>No matches in the archive.</p>';
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`${tabId}Tab`).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${tabId}TabButton`).classList.add('active');
        }
        
        function renderPlayerLists() {
            const opts = players.map(p => `<option value="${p}">${p}</option>`).join('');
            player1Select.innerHTML = `<option value="">Select Player 1</option>${opts}`;
            player2Select.innerHTML = `<option value="">Select Player 2</option>${opts}`;
            playerListContainer.innerHTML = players.map(p => `<div class="player-item"><span>${p}</span><button data-name="${p}" data-type="player" class="delete-item-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div>`).join('') || '<p>No players added yet.</p>';
        }
        
        function renderLeagueLists() {
            leagueSelect.innerHTML = `<option value="">Select League</option>${leagues.map(l => `<option value="${l}">${l}</option>`).join('')}`;
            leagueListContainer.innerHTML = leagues.map(l => `<div class="league-item"><span>${l}</span><button data-name="${l}" data-type="league" class="delete-item-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div>`).join('') || '<p>No leagues added yet.</p>';
        }
        
        function updateH2HDropdowns() {
            const activeLeague = document.querySelector('.league-tab-button.active')?.dataset.league;
            if (!activeLeague) return;
            const leagueMatches = matches.filter(m => m.league === activeLeague);
            const leaguePlayers = [...new Set(leagueMatches.flatMap(m => [m.player1Name, m.player2Name]))].sort();
            const opts = leaguePlayers.map(p => `<option value="${p}">${p}</option>`).join('');
            h2hPlayer1Select.innerHTML = `<option value="">Select Player 1</option>${opts}`;
            h2hPlayer2Select.innerHTML = `<option value="">Select Player 2</option>${opts}`;
        }

        h2hButton.addEventListener('click', () => {
            const p1 = h2hPlayer1Select.value;
            const p2 = h2hPlayer2Select.value;
            if (!p1 || !p2 || p1 === p2) {
                h2hResult.innerHTML = 'Please select two different players.'; return;
            }
            const h2hMatches = matches.filter(m => (m.player1Name === p1 && m.player2Name === p2) || (m.player1Name === p2 && m.player2Name === p1));
            let p1Wins = 0, p2Wins = 0, draws = 0;
            h2hMatches.forEach(m => {
                if (m.player1Goals === m.player2Goals) draws++;
                else if ((m.player1Name === p1 && m.player1Goals > m.player2Goals) || (m.player2Name === p1 && m.player2Goals > m.player1Goals)) p1Wins++;
                else p2Wins++;
            });
            h2hResult.innerHTML = `<p class="font-bold text-lg">${p1} ${p1Wins} - ${draws} - ${p2Wins} ${p2}</p>`;
        });

        document.addEventListener('click', e => {
            const playerLink = e.target.closest('.player-name-link');
            if (playerLink) showPlayerProfile(playerLink.dataset.playerName);

            const starButton = e.target.closest('.star-btn');
            if(starButton) toggleMOTW(starButton.dataset.id);
        });

        async function toggleMOTW(matchId) {
            const batch = writeBatch(db);
            matches.forEach(match => {
                const docRef = doc(db, 'matches', match.id);
                if (match.id === matchId) batch.update(docRef, { isMOTW: !match.isMOTW }); 
                else if (match.isMOTW) batch.update(docRef, { isMOTW: false });
            });
            await batch.commit();
        }

        function showPlayerProfile(playerName) {
            const playerMatches = matches.filter(m => m.player1Name === playerName || m.player2Name === playerName);
            let wins = 0, losses = 0, draws = 0, gf = 0, ga = 0, biggestWin = { diff: 0, score: 'N/A' };
            playerMatches.forEach(m => {
                const isPlayer1 = m.player1Name === playerName;
                const pGoals = isPlayer1 ? m.player1Goals : m.player2Goals;
                const oGoals = isPlayer1 ? m.player2Goals : m.player1Goals;
                gf += pGoals; ga += oGoals;
                if (pGoals > oGoals) {
                    wins++;
                    if (pGoals - oGoals > biggestWin.diff) biggestWin = { diff: pGoals - oGoals, score: `${pGoals} - ${oGoals}` };
                }
                else if (oGoals > playerGoals) losses++;
                else draws++;
            });
            const played = playerMatches.length;
            const winRate = played ? ((wins / played) * 100).toFixed(1) : 0;
            const gpg = played ? (gf / played).toFixed(2) : 0;
            
            playerProfileContent.innerHTML = `
                <div class="text-left">
                    <div class="flex justify-between items-center"><h2 class="text-3xl mb-4">${playerName}</h2><button id="closeProfileBtn" class="bg-gray-700 hover:bg-gray-600">Close</button></div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <p><strong>Win Rate:</strong> ${winRate}%</p><p><strong>Played:</strong> ${played}</p>
                        <p><strong>Record (W-D-L):</strong> ${wins}-${draws}-${losses}</p><p><strong>Goals per Game:</strong> ${gpg}</p>
                        <p><strong>Goals For:</strong> ${gf}</p><p><strong>Goals Against:</strong> ${ga}</p>
                        <p><strong>Biggest Win:</strong> ${biggestWin.score}</p>
                    </div>
                    <h3 class="text-xl mb-2">Match History</h3>
                    <div class="max-h-60 overflow-y-auto">${playerMatches.map(m => `<div class="match-item"><span>${m.league}: ${m.player1Name} <b>${m.player1Goals}</b> - <b>${m.player2Goals}</b> ${m.player2Name}</span></div>`).join('') || '<p>No matches played.</p>'}</div>
                </div>`;
            playerProfileModal.style.display = 'flex';
            document.getElementById('closeProfileBtn').onclick = () => playerProfileModal.style.display = 'none';
        }

        playerProfileModal.addEventListener('click', e => { if (e.target === playerProfileModal) playerProfileModal.style.display = 'none'; });
        addPlayerForm.addEventListener('submit', async e => { e.preventDefault(); const pName = document.getElementById('playerNameInput').value.trim(); if (pName && !players.includes(pName)) { await addDoc(collection(db, 'players'), { name: pName, owner: userId }); addPlayerForm.reset(); } });
        addLeagueForm.addEventListener('submit', async e => { e.preventDefault(); const lName = document.getElementById('leagueNameInput').value.trim(); if (lName && !leagues.includes(lName)) { await addDoc(collection(db, 'leagues'), { name: lName, owner: userId }); addLeagueForm.reset(); } });
        addMatchForm.addEventListener('submit', async e => { e.preventDefault(); const l = leagueSelect.value, p1 = player1Select.value, g1 = parseInt(document.getElementById('player1Goals').value), p2 = player2Select.value, g2 = parseInt(document.getElementById('player2Goals').value); if (l && p1 && p2 && !isNaN(g1) && !isNaN(g2) && p1 !== p2) { await addDoc(collection(db, 'matches'), { league:l, player1Name:p1, player1Goals:g1, player2Name:p2, player2Goals:g2, timestamp: Date.now(), isMOTW: false }); addMatchForm.reset(); } });
        document.addEventListener('click', e => { const btn = e.target.closest('.delete-item-btn'); if (btn) { itemToDelete = { id: btn.dataset.id, type: btn.dataset.type, name: btn.dataset.name }; modalText.textContent = `Delete this ${itemToDelete.type}?`; confirmationModal.style.display = 'flex'; } });
        confirmDeleteButton.addEventListener('click', async () => { if (!itemToDelete) return; if (itemToDelete.type === 'match') { await deleteDoc(doc(db, 'matches', itemToDelete.id)); } else { const q = query(collection(db, `${itemToDelete.type}s`), where("name", "==", itemToDelete.name)); const snap = await getDocs(q); snap.forEach(d => deleteDoc(d.ref)); } confirmationModal.style.display = 'none'; });
        cancelDeleteButton.addEventListener('click', () => confirmationModal.style.display = 'none');
        matchesTabButton.addEventListener('click', () => showTab('matches'));
        adminTabButton.addEventListener('click', () => showTab('admin'));
        document.addEventListener('DOMContentLoaded', startApp);
    </script>
</body>
</html>

