<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FC 2025 League Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .container {
            max-width: 90%;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #161b22;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #58a6ff;
            text-align: center;
            font-weight: 700;
        }
        .form-section, .standings-section, .archive-section, .stats-section {
            background-color: #0d1117;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            border: 1px solid #30363d;
        }
        .form-section h2, .standings-section h2, .archive-section h2, .stats-section h2 {
            margin-top: 0;
            color: #c9d1d9;
            text-align: left;
        }
        #addMatchForm {
            display: grid;
            grid-template-columns: 1fr 1fr 0.2fr 1fr 1fr 1fr;
            gap: 0.75rem;
            align-items: center;
        }
        input, button, select {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #30363d;
            background-color: #010409;
            color: #c9d1d9;
            transition: all 0.2s;
        }
        input:focus, button:hover, select:focus {
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.5);
            outline: none;
        }
        button {
            background-color: #238636;
            color: white;
            font-weight: 500;
            cursor: pointer;
        }
        button:hover {
            background-color: #2ea043;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #30363d;
        }
        th {
            background-color: #1f2730;
            color: #c9d1d9;
            font-weight: 500;
        }
        tr:hover {
            background-color: #1f2730;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #161b22;
            padding: 2rem;
            border-radius: 0.75rem;
            border: 1px solid #30363d;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .modal-content p {
            margin-bottom: 1.5rem;
        }
        .modal-buttons button {
            margin: 0 0.5rem;
            padding: 0.75rem 1.5rem;
        }
        .modal-buttons .confirm {
            background-color: #e54848;
        }
        .modal-buttons .confirm:hover {
            background-color: #f25757;
        }
        .match-item, .player-item, .league-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #30363d;
        }
        .match-item button, .player-item button, .league-item button {
            background-color: transparent;
            border: none;
            color: #e54848;
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.2s;
        }
        .match-item button:hover, .player-item button:hover, .league-item button:hover {
            color: #f25757;
        }
        @media (max-width: 768px) {
            #addMatchForm {
                grid-template-columns: 1fr;
            }
            #addMatchForm span {
                text-align: center;
            }
        }
        .tab-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .tab-button, .league-tab-button {
            padding: 0.75rem 1.5rem;
            background-color: #30363d;
            border: 1px solid #30363d;
            border-radius: 0.5rem 0.5rem 0 0;
            color: #c9d1d9;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .tab-button.active, .league-tab-button.active {
            background-color: #0d1117;
            border-bottom: 1px solid #0d1117;
        }
        .hidden { display: none; }
        .league-tabs-container {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid #30363d;
            margin-top: 1.5rem;
        }
        .rank-gold { background-color: rgba(255, 215, 0, 0.15); }
        .rank-silver { background-color: rgba(192, 192, 192, 0.15); }
        .rank-bronze { background-color: rgba(205, 127, 50, 0.15); }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="text-4xl">FC 2025 League Tracker</h1>
        <p class="text-center text-sm mt-2 text-gray-500">Your User ID: <span id="userIdDisplay">Loading...</span></p>

        <div class="tab-buttons">
            <button id="matchesTabButton" class="tab-button active">Matches</button>
            <button id="adminTabButton" class="tab-button hidden">Admin</button>
        </div>
        
        <div id="matchesTab" class="tab-content">
            <div id="leagueTabsContainer" class="league-tabs-container"></div>
            <div id="leagueContentContainer"></div>
            <div class="archive-section">
                <h2 class="text-2xl mb-4">Match Archive</h2>
                <div id="matchList"></div>
            </div>
        </div>

        <div id="adminTab" class="tab-content hidden">
            <div class="form-section">
                <h2 class="text-2xl mb-4">Add a Match Result</h2>
                <form id="addMatchForm">
                    <select id="leagueSelect" required class="w-full"></select>
                    <select id="player1Select" required class="w-full"></select>
                    <input type="number" id="player1Goals" placeholder="Goals" required class="w-full">
                    <span class="text-center font-bold text-gray-500 text-lg">vs</span>
                    <input type="number" id="player2Goals" placeholder="Goals" required class="w-full">
                    <select id="player2Select" required class="w-full"></select>
                    <button type="submit" class="w-full">Add Match</button>
                </form>
            </div>
            <div class="form-section">
                <h2 class="text-2xl mb-4">Add a New Player</h2>
                <form id="addPlayerForm" class="flex flex-col gap-4">
                    <input type="text" id="playerNameInput" placeholder="Player Name" required>
                    <button type="submit">Add Player</button>
                </form>
                <div id="playerList" class="mt-4"></div>
            </div>

            <div class="form-section">
                <h2 class="text-2xl mb-4">Add a New League</h2>
                <form id="addLeagueForm" class="flex flex-col gap-4">
                    <input type="text" id="leagueNameInput" placeholder="League Name" required>
                    <button type="submit">Add League</button>
                </form>
                <div id="leagueList" class="mt-4"></div>
            </div>
        </div>

    </div>

    <!-- The Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <p id="modalText"></p>
            <div class="modal-buttons">
                <button id="cancelDeleteButton" class="bg-gray-700 hover:bg-gray-600">Cancel</button>
                <button id="confirmDeleteButton" class="confirm hover:bg-red-600">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyBvXdFou9yUlERH-iaICi6JjNChw1rC2O0",
          authDomain: "fun-league-6edd6.firebaseapp.com",
          projectId: "fun-league-6edd6",
          storageBucket: "fun-league-6edd6.appspot.com",
          messagingSenderId: "132854098604",
          appId: "1:132854098604:web:0c0e829ac99624dac38d09",
          measurementId: "G-QJCY28B9HM"
        };
        
        const adminUID = "PASTE_YOUR_ADMIN_USER_ID_HERE";

        // DOM element references
        const addMatchForm = document.getElementById('addMatchForm');
        const leagueTabsContainer = document.getElementById('leagueTabsContainer');
        const leagueContentContainer = document.getElementById('leagueContentContainer');
        const matchList = document.getElementById('matchList');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        const player1Select = document.getElementById('player1Select');
        const player2Select = document.getElementById('player2Select');
        const leagueSelect = document.getElementById('leagueSelect');
        const addPlayerForm = document.getElementById('addPlayerForm');
        const addLeagueForm = document.getElementById('addLeagueForm');
        const playerListContainer = document.getElementById('playerList');
        const leagueListContainer = document.getElementById('leagueList');
        const modalText = document.getElementById('modalText');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const matchesTabButton = document.getElementById('matchesTabButton');
        const adminTabButton = document.getElementById('adminTabButton');
        
        let db, auth, userId;
        let itemToDelete = null;
        let players = [], leagues = [], matches = [];
        
        async function startApp() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                auth.onAuthStateChanged(user => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        adminTabButton.classList.toggle('hidden', userId !== adminUID);
                        setupListeners();
                    } else {
                        userIdDisplay.textContent = "Signed Out";
                        adminTabButton.classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                userIdDisplay.textContent = "Error";
            }
        }
        
        function setupListeners() {
            onSnapshot(collection(db, 'players'), snapshot => {
                players = snapshot.docs.map(doc => doc.data().name);
                renderPlayerLists();
                renderAllLeagueData();
            });
            onSnapshot(collection(db, 'leagues'), snapshot => {
                leagues = snapshot.docs.map(doc => doc.data().name);
                renderLeagueLists();
                renderAllLeagueData();
            });
            onSnapshot(query(collection(db, 'matches')), snapshot => {
                matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMatchList();
                renderAllLeagueData();
            });
        }

        function renderAllLeagueData() {
            if (!leagues.length || !players.length) return;

            leagueTabsContainer.innerHTML = '';
            leagueContentContainer.innerHTML = '';

            leagues.forEach((league, index) => {
                // Create Tab Button
                const tabButton = document.createElement('button');
                tabButton.className = 'league-tab-button';
                tabButton.textContent = league;
                tabButton.dataset.league = league;
                if (index === 0) tabButton.classList.add('active');
                tabButton.onclick = () => switchLeagueTab(league);
                leagueTabsContainer.appendChild(tabButton);

                // Create Content Div
                const contentDiv = document.createElement('div');
                contentDiv.id = `content-${league}`;
                contentDiv.className = 'league-content';
                if (index !== 0) contentDiv.classList.add('hidden');
                
                const leagueMatches = matches.filter(m => m.league === league);
                const leaguePlayers = [...new Set(leagueMatches.flatMap(m => [m.player1Name, m.player2Name]))];
                
                // Standings
                const standings = calculateLeagueStats(leagueMatches, leaguePlayers);
                contentDiv.innerHTML += generateStandingsHTML(league, standings);

                // Top Players
                const { topScorers, topDefenders } = calculateTopPlayers(leagueMatches, leaguePlayers);
                contentDiv.innerHTML += generateTopPlayersHTML(topScorers, topDefenders);

                leagueContentContainer.appendChild(contentDiv);
            });
        }

        function switchLeagueTab(leagueName) {
            document.querySelectorAll('.league-tab-button').forEach(btn => btn.classList.toggle('active', btn.dataset.league === leagueName));
            document.querySelectorAll('.league-content').forEach(content => content.classList.toggle('hidden', content.id !== `content-${leagueName}`));
        }

        function calculateLeagueStats(leagueMatches, leaguePlayers) {
            const stats = {};
            leaguePlayers.forEach(p => {
                stats[p] = { player: p, played: 0, wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, gd: 0, points: 0 };
            });

            leagueMatches.forEach(m => {
                const s1 = stats[m.player1Name], s2 = stats[m.player2Name];
                s1.played++; s2.played++;
                s1.gf += m.player1Goals; s1.ga += m.player2Goals;
                s2.gf += m.player2Goals; s2.ga += m.player1Goals;
                s1.gd = s1.gf - s1.ga; s2.gd = s2.gf - s2.ga;

                if (m.player1Goals > m.player2Goals) { s1.wins++; s1.points += 3; s2.losses++; }
                else if (m.player2Goals > m.player1Goals) { s2.wins++; s2.points += 3; s1.losses++; }
                else { s1.draws++; s1.points++; s2.draws++; s2.points++; }
            });

            return Object.values(stats).sort((a, b) => b.points - a.points || b.gd - a.gd || b.gf - a.gf);
        }

        function getRankClass(index) {
            if (index === 0) return 'rank-gold';
            if (index === 1) return 'rank-silver';
            if (index === 2) return 'rank-bronze';
            return '';
        }

        function generateStandingsHTML(leagueName, standings) {
             if (standings.length === 0) return '';
             return `<div class="standings-section">
                <h2 class="text-2xl mb-4">${leagueName} Standings</h2>
                <table class="w-full"><thead><tr>
                    <th>Rank</th><th>Player</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th>
                </tr></thead><tbody>
                ${standings.map((p, i) => `
                    <tr class="${getRankClass(i)}">
                        <td>${i + 1}</td><td>${p.player}</td><td>${p.played}</td><td>${p.wins}</td>
                        <td>${p.draws}</td><td>${p.losses}</td><td>${p.gf}</td>
                        <td>${p.ga}</td><td>${p.gd}</td><td class="font-bold">${p.points}</td>
                    </tr>`).join('')}
                </tbody></table></div>`;
        }

        function calculateTopPlayers(leagueMatches, leaguePlayers) {
            const stats = {};
            leaguePlayers.forEach(p => { stats[p] = { player: p, gf: 0, ga: 0 }; });
            leagueMatches.forEach(m => {
                stats[m.player1Name].gf += m.player1Goals;
                stats[m.player1Name].ga += m.player2Goals;
                stats[m.player2Name].gf += m.player2Goals;
                stats[m.player2Name].ga += m.player1Goals;
            });
            const allStats = Object.values(stats);
            const topScorers = [...allStats].sort((a,b) => b.gf - a.gf).slice(0, 3);
            const topDefenders = [...allStats].sort((a,b) => a.ga - b.ga).slice(0, 3);
            return { topScorers, topDefenders };
        }
        
        function generateTopPlayersHTML(topScorers, topDefenders) {
             return `<div class="flex flex-col md:flex-row gap-4">
                <div class="stats-section flex-1">
                    <h2 class="text-2xl mb-4">Top Goal Scorers</h2>
                    <table><thead><tr><th>Rank</th><th>Player</th><th>Goals</th></tr></thead><tbody>
                        ${topScorers.map((p, i) => `<tr><td>${i+1}</td><td>${p.player}</td><td class="font-bold">${p.gf}</td></tr>`).join('')}
                    </tbody></table>
                </div>
                <div class="stats-section flex-1">
                    <h2 class="text-2xl mb-4">Top Defenders</h2>
                    <table><thead><tr><th>Rank</th><th>Player</th><th>Goals Against</th></tr></thead><tbody>
                        ${topDefenders.map((p, i) => `<tr><td>${i+1}</td><td>${p.player}</td><td class="font-bold">${p.ga}</td></tr>`).join('')}
                    </tbody></table>
                </div>
            </div>`;
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`${tabId}Tab`).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${tabId}TabButton`).classList.add('active');
        }
        
        function renderPlayerLists() {
            const opts = players.map(p => `<option value="${p}">${p}</option>`).join('');
            player1Select.innerHTML = `<option value="">Select Player 1</option>${opts}`;
            player2Select.innerHTML = `<option value="">Select Player 2</option>${opts}`;
            playerListContainer.innerHTML = players.map(p => `<div class="player-item"><span>${p}</span><button data-name="${p}" data-type="player" class="delete-item-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div>`).join('') || '<p>No players added yet.</p>';
        }
        
        function renderLeagueLists() {
            leagueSelect.innerHTML = `<option value="">Select League</option>${leagues.map(l => `<option value="${l}">${l}</option>`).join('')}`;
            leagueListContainer.innerHTML = leagues.map(l => `<div class="league-item"><span>${l}</span><button data-name="${l}" data-type="league" class="delete-item-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div>`).join('') || '<p>No leagues added yet.</p>';
        }

        function renderMatchList() {
            const isAdmin = userId === adminUID;
            matchList.innerHTML = [...matches].sort((a,b) => b.timestamp - a.timestamp).map(m => `
                <div class="match-item">
                    <span>${m.league}: ${m.player1Name} <b>${m.player1Goals}</b> - <b>${m.player2Goals}</b> ${m.player2Name}</span>
                    ${isAdmin ? `<button data-id="${m.id}" data-type="match" class="delete-item-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>` : ''}
                </div>`).join('') || '<p>No matches in the archive.</p>';
        }

        addPlayerForm.addEventListener('submit', async e => {
            e.preventDefault();
            const playerName = document.getElementById('playerNameInput').value.trim();
            if (playerName && !players.includes(playerName)) {
                await addDoc(collection(db, 'players'), { name: playerName, owner: userId });
                addPlayerForm.reset();
            }
        });

        addLeagueForm.addEventListener('submit', async e => {
            e.preventDefault();
            const leagueName = document.getElementById('leagueNameInput').value.trim();
            if (leagueName && !leagues.includes(leagueName)) {
                await addDoc(collection(db, 'leagues'), { name: leagueName, owner: userId });
                addLeagueForm.reset();
            }
        });

        addMatchForm.addEventListener('submit', async e => {
            e.preventDefault();
            const league = leagueSelect.value, p1 = player1Select.value, g1 = parseInt(document.getElementById('player1Goals').value),
                  p2 = player2Select.value, g2 = parseInt(document.getElementById('player2Goals').value);
            if (league && p1 && p2 && !isNaN(g1) && !isNaN(g2) && p1 !== p2) {
                await addDoc(collection(db, 'matches'), { league, player1Name: p1, player1Goals: g1, player2Name: p2, player2Goals: g2, timestamp: Date.now() });
                addMatchForm.reset();
            }
        });

        document.addEventListener('click', e => {
            const button = e.target.closest('.delete-item-btn');
            if (button) {
                itemToDelete = { id: button.dataset.id, type: button.dataset.type, name: button.dataset.name };
                modalText.textContent = `Are you sure you want to delete this ${itemToDelete.type}?`;
                confirmationModal.style.display = 'flex';
            }
        });

        confirmDeleteButton.addEventListener('click', async () => {
            if (!itemToDelete) return;
            if (itemToDelete.type === 'match') {
                await deleteDoc(doc(db, 'matches', itemToDelete.id));
            } else {
                const q = query(collection(db, `${itemToDelete.type}s`), where("name", "==", itemToDelete.name));
                const snapshot = await getDocs(q);
                snapshot.forEach(d => deleteDoc(d.ref));
            }
            confirmationModal.style.display = 'none';
        });

        cancelDeleteButton.addEventListener('click', () => confirmationModal.style.display = 'none');
        matchesTabButton.addEventListener('click', () => showTab('matches'));
        adminTabButton.addEventListener('click', () => showTab('admin'));
        document.addEventListener('DOMContentLoaded', startApp);
    </script>
</body>
</html>

