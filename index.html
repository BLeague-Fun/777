<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FC 2025 League Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; color: #333; }
        .container { max-width: 90%; margin: 2rem auto; padding: 2rem; background-color: rgba(255, 255, 255, 0.85); border-radius: 1rem; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #00b894; text-align: center; font-weight: 700; }
        .standings-section, .archive-section, .stats-section { background-color: rgba(255, 255, 255, 0.9); padding: 1.5rem; border-radius: 0.75rem; margin-top: 1.5rem; border: 1px solid #e9ecef; }
        .standings-section h2, .archive-section h2, .stats-section h2 { margin-top: 0; color: #00b894; text-align: left; display: flex; align-items: center; }
        h2 .icon { margin-right: 0.75rem; font-size: 1.25rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e9ecef; white-space: nowrap; }
        th { background-color: #f8f9fa; font-weight: 500; }
        tr:hover { background-color: #f8f9fa; }
        .league-tab-button { padding: 0.75rem 1.5rem; background-color: #e9ecef; border: 1px solid #dee2e6; border-radius: 0.5rem 0.5rem 0 0; color: #495057; cursor: pointer; transition: background-color 0.2s; }
        .league-tab-button.active { background-color: #fff; border-bottom-color: #fff; }
        .hidden { display: none; }
        .league-tabs-container { display: flex; flex-wrap: wrap; border-bottom: 1px solid #dee2e6; margin-top: 1.5rem; }
        .rank-gold { background-color: rgba(255, 215, 0, 0.15); }
        .rank-silver { background-color: rgba(192, 192, 192, 0.15); }
        .rank-bronze { background-color: rgba(205, 127, 50, 0.15); }
        a.player-name-link { text-decoration: none; color: #00b894; font-weight: 500; transition: color 0.2s; }
        a.player-name-link:hover { text-decoration: underline; color: #00a884; }
        #adminLink, #statsLink { position: absolute; top: 2.5rem; background-color: #00b894; color: white; }
        #adminLink:hover, #statsLink:hover { background-color: #00a884; }
        #adminLink { right: 2.5rem; }
        #statsLink { right: 10.5rem; }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #e9ecef; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb { background: #00b894; border-radius: 10px; }
        .league-content { animation: crossFade 0.4s ease-in-out; }
        .form-guide-icon { width: 1rem; height: 1rem; border-radius: 50%; display: inline-block; margin-right: 0.25rem; }
        .win { background-color: #28a745; }
        .draw { background-color: #ffc107; }
        .loss { background-color: #dc3545; }
        
        @keyframes crossFade { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 768px) {
            .container { padding: 1rem; margin: 1rem auto; max-width: 100%; }
            h1 { font-size: 1.875rem; }
            #adminLink, #statsLink { position: static; display: block; width: fit-content; margin: 0.5rem auto; }
        }
    </style>
</head>
<body>

    <div class="container relative">
        <a id="statsLink" href="stats.html" class="p-2 rounded-lg text-white no-underline">Hall of Fame</a>
        <a id="adminLink" href="admin.html" class="hidden p-2 rounded-lg text-white no-underline">Admin Panel</a>
        <h1 class="text-4xl font-extrabold">FC 2025 League Tracker</h1>
        <p class="text-center text-sm mt-2"><span id="userIdDisplay">Loading...</span></p>

        <div id="mainContent">
            <div id="leagueTabsContainer" class="league-tabs-container"></div>
            <div id="leagueContentContainer"></div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyBvXdFou9yUlERH-iaICi6JjNChw1rC2O0",
          authDomain: "fun-league-6edd6.firebaseapp.com",
          projectId: "fun-league-6edd6",
          storageBucket: "fun-league-6edd6.appspot.com",
          messagingSenderId: "132854098604",
          appId: "1:132854098604:web:0c0e829ac99624dac38d09",
          measurementId: "G-QJCY28B9HM"
        };
        
        const adminUID = "ujMJ9cUFxxguzNmezN6iF2TQNN52";

        const adminLink = document.getElementById('adminLink');
        const leagueTabsContainer = document.getElementById('leagueTabsContainer');
        const leagueContentContainer = document.getElementById('leagueContentContainer');
        const userIdDisplay = document.getElementById('userIdDisplay');
        
        let db, auth, userId;
        let players = [], leagues = [], matches = [], clubAssignments = {}, clubs = [];
        
        async function startApp() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                auth.onAuthStateChanged(user => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        adminLink.classList.toggle('hidden', userId !== adminUID);
                        setupListeners();
                    } else {
                        userIdDisplay.textContent = "Signed Out";
                        adminLink.classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                userIdDisplay.textContent = "Error";
            }
        }
        
        function setupListeners() {
            onSnapshot(collection(db, 'players'), snapshot => {
                players = snapshot.docs.map(doc => doc.data().name);
                renderAllLeagueData();
            });
            onSnapshot(collection(db, 'leagues'), snapshot => {
                leagues = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderAllLeagueData();
            });
            onSnapshot(collection(db, 'matches'), snapshot => {
                matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllLeagueData();
            });
             onSnapshot(collection(db, 'clubs'), snapshot => {
                clubs = snapshot.docs.map(doc => doc.data());
                renderAllLeagueData();
            });
             onSnapshot(collection(db, 'clubAssignments'), snapshot => {
                clubAssignments = {};
                snapshot.forEach(doc => {
                    clubAssignments[doc.id] = doc.data();
                });
                renderAllLeagueData();
            });
        }

        function renderAllLeagueData() {
            if (!leagues.length) return;
            const leagueNames = leagues.filter(l => l.status !== 'ended').map(l => l.name);
            const activeLeague = document.querySelector('.league-tab-button.active')?.dataset.league || (leagueNames.length > 0 ? leagueNames[0] : null);

            leagueTabsContainer.innerHTML = '';
            leagueContentContainer.innerHTML = '';

            leagueNames.forEach(league => {
                const tabButton = document.createElement('button');
                tabButton.className = 'league-tab-button';
                tabButton.textContent = league;
                tabButton.dataset.league = league;
                if (league === activeLeague) tabButton.classList.add('active');
                tabButton.onclick = () => switchLeagueTab(league);
                leagueTabsContainer.appendChild(tabButton);

                const contentDiv = document.createElement('div');
                contentDiv.id = `content-${league}`;
                contentDiv.className = 'league-content';
                if (league !== activeLeague) contentDiv.classList.add('hidden');
                
                const completedMatches = matches.filter(m => m.league === league && m.status === 'completed').sort((a,b) => a.timestamp - b.timestamp);
                const leaguePlayers = [...new Set(completedMatches.flatMap(m => [m.player1Name, m.player2Name]))];
                
                const standings = calculateLeagueStats(completedMatches, leaguePlayers);
                contentDiv.innerHTML += generateStandingsHTML(league, standings, completedMatches);
                
                leagueContentContainer.appendChild(contentDiv);
            });
        }

        function switchLeagueTab(leagueName) {
            document.querySelectorAll('.league-tab-button').forEach(btn => btn.classList.toggle('active', btn.dataset.league === leagueName));
            document.querySelectorAll('.league-content').forEach(content => content.classList.toggle('hidden', content.id !== `content-${leagueName}`));
        }

        function calculateLeagueStats(leagueMatches, leaguePlayers) {
            const stats = {};
            leaguePlayers.forEach(p => {
                stats[p] = { player: p, played: 0, wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, gd: 0, points: 0 };
            });

            leagueMatches.forEach(m => {
                const s1 = stats[m.player1Name], s2 = stats[m.player2Name];
                if (!s1 || !s2) return;
                s1.played++; s2.played++;
                s1.gf += m.player1Goals; s1.ga += m.player2Goals;
                s2.gf += m.player2Goals; s2.ga += m.player1Goals;
                s1.gd = s1.gf - s1.ga; s2.gd = s2.gf - s2.ga;

                if (m.player1Goals > m.player2Goals) { s1.wins++; s1.points += 3; s2.losses++; }
                else if (m.player2Goals > m.player1Goals) { s2.wins++; s2.points += 3; s1.losses++; }
                else { s1.draws++; s1.points++; s2.draws++; s2.points++; }
            });

            return Object.values(stats).sort((a, b) => b.points - a.points || b.gd - a.gd || b.gf - a.gf);
        }

        function getRankClass(index) {
            if (index === 0) return 'rank-gold';
            if (index === 1) return 'rank-silver';
            if (index === 2) return 'rank-bronze';
            return '';
        }

        function getFormGuide(player, leagueMatches) {
            const playerMatches = leagueMatches.filter(m => m.player1Name === player || m.player2Name === player).slice(-5);
            return playerMatches.map(m => {
                const isP1 = m.player1Name === player;
                const pGoals = isP1 ? m.player1Goals : m.player2Goals;
                const oGoals = isP1 ? m.player2Goals : m.player1Goals;
                if (pGoals > oGoals) return '<span class="form-guide-icon win" title="Win"></span>';
                if (pGoals < oGoals) return '<span class="form-guide-icon loss" title="Loss"></span>';
                return '<span class="form-guide-icon draw" title="Draw"></span>';
            }).join('');
        }

        function generateStandingsHTML(leagueName, standings, leagueMatches) {
             if (standings.length === 0) return `<div class="standings-section"><h2 class="text-2xl"><span class="icon">üèÜ</span>${leagueName} Standings</h2><p>No matches played yet in this league.</p></div>`;
             return `<div class="standings-section">
                <h2 class="text-2xl mb-4"><span class="icon">üèÜ</span>${leagueName} Standings</h2>
                <div class="table-container">
                    <table class="w-full"><thead><tr>
                        <th>Rank</th><th>Player</th><th>Club</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th><th>Form</th>
                    </tr></thead><tbody>
                    ${standings.map((p, i) => {
                        const clubName = clubAssignments[leagueName]?.[p.player] || 'N/A';
                        const club = clubs.find(c => c.name === clubName);
                        const clubLogo = club?.logoUrl || 'https://placehold.co/24x24/e9ecef/495057?text=?';

                        return `<tr class="${getRankClass(i)}">
                            <td>${i + 1}</td>
                            <td><a href="profile.html?player=${encodeURIComponent(p.player)}" class="player-name-link">${p.player}</a></td>
                            <td><img src="${clubLogo}" alt="${clubName}" class="club-logo-sm">${clubName}</td>
                            <td>${p.played}</td><td>${p.wins}</td>
                            <td>${p.draws}</td><td>${p.losses}</td><td>${p.gf}</td>
                            <td>${p.ga}</td><td>${p.gd}</td><td class="font-bold">${p.points}</td>
                            <td>${getFormGuide(p.player, leagueMatches)}</td>
                        </tr>`
                    }).join('')}
                    </tbody></table>
                </div>
            </div>`;
        }
        
        document.addEventListener('DOMContentLoaded', startApp);
    </script>
</body>
</html>
