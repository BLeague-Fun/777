<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - FC 2025 League Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 90%;
            margin: 2rem auto;
            padding: 2rem;
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #00b894;
            text-align: center;
            font-weight: 700;
        }
        .form-section {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            border: 1px solid #e9ecef;
        }
        .form-section h2 {
            margin-top: 0;
            color: #00b894;
            text-align: left;
        }
        input, button, select {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #dee2e6;
            background-color: #f6f8fa;
            color: #333;
            transition: all 0.2s;
        }
        input:focus, button:hover, select:focus {
            border-color: #00b894;
            box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.2);
            outline: none;
        }
        button, .button {
            background-color: #00b894;
            color: white;
            font-weight: 500;
            cursor: pointer;
        }
        button:hover, .button:hover {
            background-color: #00a884;
        }
        .button.disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .delete-item-btn, .edit-item-btn, .end-league-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.2s;
        }
        .delete-item-btn, .end-league-btn { color: #dc3545; }
        .delete-item-btn:hover, .end-league-btn:hover { color: #c82333; }
        .edit-item-btn { color: #00b894; }
        .edit-item-btn:hover { color: #00a884; }
        .player-item, .league-item, .match-management-item, .club-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #dee2e6;
        }
        .hidden { display: none; }
        .star-btn { color: #adb5bd; cursor: pointer; background: none; border: none; font-size: 1.5rem; }
        .star-btn.active { color: #ffc107; }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            justify-content: center; align-items: center; overflow-y: auto;
        }
        .modal-content {
            background-color: #fff; padding: 2rem; border-radius: 0.75rem; border: 1px solid #e9ecef;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 90%; max-width: 500px;
        }
        #createLeagueForm .player-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.5rem;
        }
         .player-avatar, .club-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 1rem;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loginSection">
             <h1 class="text-4xl font-extrabold">Admin Login</h1>
             <form id="loginForm" class="form-section max-w-sm mx-auto">
                <div class="mb-4"><label for="email" class="block mb-2">Email</label><input type="email" id="email" required class="w-full"></div>
                <div class="mb-6"><label for="password" class="block mb-2">Password</label><input type="password" id="password" required class="w-full"></div>
                <button type="submit" class="w-full">Login</button>
                <p id="loginError" class="text-red-500 text-center mt-4 hidden"></p>
             </form>
        </div>

        <div id="adminControls" class="hidden">
            <h1 class="text-4xl font-extrabold">Admin Panel</h1>
            <p class="text-center mt-2"><a href="index.html" class="text-green-500 hover:underline">← Back to Main Page</a></p>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                 <div class="form-section">
                    <h2 class="text-2xl mb-4">Pending Games</h2>
                    <div id="pendingGamesList" class="max-h-96 overflow-y-auto"></div>
                </div>
                <div class="form-section">
                    <h2 class="text-2xl mb-4">Completed Matches</h2>
                    <div id="completedGamesList" class="max-h-96 overflow-y-auto"></div>
                </div>
            </div>

            <div class="form-section">
                <h2 class="text-2xl mb-4">Manage Club Assignments</h2>
                <div class="flex flex-col gap-4">
                    <select id="clubLeagueSelect" class="w-full"></select>
                    <div id="clubAssignmentsContainer" class="max-h-72 overflow-y-auto"></div>
                    <button id="saveClubAssignments" class="w-full">Save Assignments</button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div class="form-section">
                    <h2 class="text-2xl mb-4">Manage Leagues</h2>
                     <form id="createLeagueForm" class="flex flex-col gap-4">
                        <input type="text" id="leagueNameInput" placeholder="New League Name" required>
                        <div class="border rounded-md p-2">
                             <p class="font-bold mb-2">Select Players for Roster:</p>
                            <div id="playerRosterChecklist" class="player-checklist max-h-40 overflow-y-auto"></div>
                        </div>
                        <button type="submit">Create League</button>
                    </form>
                    <div id="leagueList" class="mt-4 max-h-60 overflow-y-auto"></div>
                </div>
                <div class="form-section">
                    <h2 class="text-2xl mb-4">Manage Players</h2>
                    <form id="addPlayerForm" class="flex flex-col gap-4">
                        <input type="text" id="playerNameInput" placeholder="New Player Name" required>
                        <input type="email" id="playerEmailInput" placeholder="Player Email">
                        <input type="url" id="playerAvatarInput" placeholder="Player Avatar URL">
                        <button type="submit">Add Player</button>
                    </form>
                    <div id="playerList" class="mt-4 max-h-60 overflow-y-auto"></div>
                </div>
                <div class="form-section">
                    <h2 class="text-2xl mb-4">Manage Clubs</h2>
                    <form id="addClubForm" class="flex flex-col gap-4">
                        <input type="text" id="clubNameInput" placeholder="Club Name" required>
                        <input type="url" id="clubLogoInput" placeholder="Club Logo URL">
                        <button type="submit">Add Club</button>
                    </form>
                    <div id="clubList" class="mt-4 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="enterResultModal" class="modal"><div class="modal-content"></div></div>
    <div id="editMatchModal" class="modal"><div class="modal-content"></div></div>
    <div id="fixtureOptionsModal" class="modal"><div class="modal-content"></div></div>
    <div id="editPlayerModal" class="modal"><div class="modal-content"></div></div>
    <div id="editLeagueModal" class="modal"><div class="modal-content"></div></div>
    <div id="editClubModal" class="modal"><div class="modal-content"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, updateDoc, setDoc, onSnapshot, collection, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBvXdFou9yUlERH-iaICi6JjNChw1rC2O0",
          authDomain: "fun-league-6edd6.firebaseapp.com",
          projectId: "fun-league-6edd6",
          storageBucket: "fun-league-6edd6.appspot.com",
          messagingSenderId: "132854098604",
          appId: "1:132854098604:web:0c0e829ac99624dac38d09",
          measurementId: "G-QJCY28B9HM"
        };
        
        const adminUID = "ujMJ9cUFxxguzNmezN6iF2TQNN52";

        const loginSection = document.getElementById('loginSection');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const adminControls = document.getElementById('adminControls');
        const createLeagueForm = document.getElementById('createLeagueForm');
        const leagueNameInput = document.getElementById('leagueNameInput');
        const playerRosterChecklist = document.getElementById('playerRosterChecklist');
        const addPlayerForm = document.getElementById('addPlayerForm');
        const addClubForm = document.getElementById('addClubForm');
        const playerListContainer = document.getElementById('playerList');
        const leagueListContainer = document.getElementById('leagueList');
        const clubListContainer = document.getElementById('clubList');
        const pendingGamesList = document.getElementById('pendingGamesList');
        const completedGamesList = document.getElementById('completedGamesList');
        const enterResultModal = document.getElementById('enterResultModal');
        const editMatchModal = document.getElementById('editMatchModal');
        const fixtureOptionsModal = document.getElementById('fixtureOptionsModal');
        const editPlayerModal = document.getElementById('editPlayerModal');
        const editLeagueModal = document.getElementById('editLeagueModal');
        const editClubModal = document.getElementById('editClubModal');
        const clubLeagueSelect = document.getElementById('clubLeagueSelect');
        const clubAssignmentsContainer = document.getElementById('clubAssignmentsContainer');
        const saveClubAssignments = document.getElementById('saveClubAssignments');

        let db, auth, userId;
        let players = [], leagues = [], matches = [], clubAssignments = {}, clubs = [];
        let activeFixtureLeague = {};

        async function startApp() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                onAuthStateChanged(auth, user => {
                    if (user && user.uid === adminUID) {
                        userId = user.uid;
                        loginSection.classList.add('hidden');
                        adminControls.classList.remove('hidden');
                        setupListeners();
                    } else {
                        loginSection.classList.remove('hidden');
                        adminControls.classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                loginError.textContent = "Initialization failed. Check console.";
                loginError.classList.remove('hidden');
            }
        }
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.classList.add('hidden');
            try { await signInWithEmailAndPassword(auth, email, password); } 
            catch (error) {
                console.error("Login failed:", error);
                loginError.textContent = "Login failed. Please check your credentials.";
                loginError.classList.remove('hidden');
            }
        });

        function setupListeners() {
            onSnapshot(collection(db, 'players'), snapshot => {
                players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPlayerLists();
            });
            onSnapshot(collection(db, 'leagues'), snapshot => {
                leagues = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLeagueLists();
                renderClubLeagueSelect();
            });
            onSnapshot(collection(db, 'matches'), snapshot => {
                matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPendingGamesList();
                renderCompletedGamesList();
            });
            onSnapshot(collection(db, 'clubAssignments'), snapshot => {
                clubAssignments = {};
                snapshot.forEach(doc => { clubAssignments[doc.id] = doc.data(); });
                renderClubAssignments();
            });
            onSnapshot(collection(db, 'clubs'), snapshot => {
                clubs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderClubList();
                renderClubAssignments();
            });
        }
        
        function renderPlayerLists() {
            playerRosterChecklist.innerHTML = players.map(p => `<div><input type="checkbox" id="player-${p.id}" value="${p.name}" class="mr-2"><label for="player-${p.id}">${p.name}</label></div>`).join('');
            playerListContainer.innerHTML = players.map(p => `
                <div class="player-item">
                    <div class="flex items-center">
                        <img src="${p.avatarUrl || 'https://placehold.co/40x40/e9ecef/495057?text=?'}" alt="${p.name}" class="player-avatar">
                        <div>
                            <p class="font-bold">${p.name}</p>
                            <p class="text-sm text-gray-500">${p.email || 'No email'}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="edit-item-btn" data-id="${p.id}" data-type="player"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button>
                        <button class="delete-item-btn" data-id="${p.id}" data-type="player"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    </div>
                </div>`).join('') || '<p>No players added yet.</p>';
        }

        function renderClubList() {
            clubListContainer.innerHTML = clubs.map(c => `
                <div class="club-item">
                    <div class="flex items-center">
                        <img src="${c.logoUrl || 'https://placehold.co/40x40/e9ecef/495057?text=?'}" alt="${c.name}" class="club-logo">
                        <p>${c.name}</p>
                    </div>
                     <div class="flex items-center gap-2">
                        <button class="edit-item-btn" data-id="${c.id}" data-type="club"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button>
                        <button class="delete-item-btn" data-id="${c.id}" data-type="club"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    </div>
                </div>`).join('') || '<p>No clubs added yet.</p>';
        }
        
        function renderLeagueLists() {
            leagueListContainer.innerHTML = leagues.map(l => `
                <div class="league-item">
                     <div class="flex items-center gap-2">
                        <span>${l.name}</span> 
                        <button class="edit-item-btn" data-id="${l.id}" data-type="league"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button>
                    </div>
                    <div class="flex items-center gap-2">
                         <button class="generate-fixtures-btn button text-sm p-2 ${l.fixturesGenerated || l.status === 'ended' ? 'disabled' : ''}" data-league-id="${l.id}" data-league-name="${l.name}" ${l.fixturesGenerated || l.status === 'ended' ? 'disabled' : ''}>Generate Fixtures</button>
                         <button class="end-league-btn" data-league-id="${l.id}" data-league-name="${l.name}" title="End League & Award Titles" ${l.status === 'ended' ? 'disabled' : ''}><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>
                    </div>
                </div>`).join('') || '<p>No leagues created yet.</p>';
        }

        function renderPendingGamesList() {
            const pendingMatches = matches.filter(m => m.status === 'pending');
            const matchesByLeague = pendingMatches.reduce((acc, match) => {
                (acc[match.league] = acc[match.league] || []).push(match);
                return acc;
            }, {});

            pendingGamesList.innerHTML = Object.keys(matchesByLeague).sort().map(leagueName => `
                <div class="mb-4">
                    <h3 class="text-xl font-bold border-b border-gray-400 pb-1 mb-2">${leagueName}</h3>
                    ${matchesByLeague[leagueName].sort((a,b) => a.timestamp - b.timestamp).map(m => `
                        <div class="match-management-item">
                            <span>${m.player1Name} vs ${m.player2Name}</span>
                            <button class="enter-result-btn button p-2 text-sm" data-id="${m.id}">Enter Result</button>
                        </div>
                    `).join('')}
                </div>
            `).join('') || '<p>No pending games.</p>';
        }

        function renderCompletedGamesList() {
             const completedMatches = matches.filter(m => m.status === 'completed');
            const matchesByLeague = completedMatches.reduce((acc, match) => {
                (acc[match.league] = acc[match.league] || []).push(match);
                return acc;
            }, {});

            completedGamesList.innerHTML = Object.keys(matchesByLeague).sort().map(leagueName => `
                <div class="mb-4">
                    <h3 class="text-xl font-bold border-b border-gray-400 pb-1 mb-2">${leagueName}</h3>
                    ${matchesByLeague[leagueName].sort((a,b) => b.timestamp - a.timestamp).map(m => `
                        <div class="match-management-item">
                            <span>${m.player1Name} <b>${m.player1Goals}</b> - <b>${m.player2Goals}</b> ${m.player2Name}</span>
                            <div class="flex items-center gap-2">
                                <button class="star-btn ${m.isMOTW ? 'active' : ''}" data-id="${m.id}" title="Set as Match of the Week">★</button>
                                <button class="edit-item-btn" data-id="${m.id}" title="Edit Match"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button>
                                <button class="delete-item-btn" data-id="${m.id}" data-type="match" title="Delete Match"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('') || '<p>No completed matches.</p>';
        }
        
        function renderClubLeagueSelect() {
            clubLeagueSelect.innerHTML = `<option value="">Select a League to Assign Clubs</option>${leagues.map(l => `<option value="${l.name}">${l.name}</option>`).join('')}`;
        }
        
        clubLeagueSelect.addEventListener('change', renderClubAssignments);

        function renderClubAssignments() {
            const selectedLeague = clubLeagueSelect.value;
            if (!selectedLeague) {
                clubAssignmentsContainer.innerHTML = '<p>Please select a league.</p>';
                return;
            }
            const leagueData = leagues.find(l => l.name === selectedLeague);
            const leaguePlayers = leagueData?.roster || [];
            const currentAssignments = clubAssignments[selectedLeague] || {};

            clubAssignmentsContainer.innerHTML = leaguePlayers.sort().map(p => `
                <div class="flex items-center gap-4 mb-2">
                    <label class="w-1/3 text-right">${p}</label>
                     <select data-player="${p}" class="w-2/3">
                        <option value="">Select Club</option>
                        ${clubs.map(c => `<option value="${c.name}" ${currentAssignments[p] === c.name ? 'selected' : ''}>${c.name}</option>`).join('')}
                    </select>
                </div>
            `).join('');
        }
        
        saveClubAssignments.addEventListener('click', async () => {
            const selectedLeague = clubLeagueSelect.value;
            if (!selectedLeague) {
                alert('Please select a league first.');
                return;
            }
            const assignments = {};
            document.querySelectorAll('#clubAssignmentsContainer select').forEach(select => {
                assignments[select.dataset.player] = select.value;
            });
            await setDoc(doc(db, 'clubAssignments', selectedLeague), assignments);
            alert('Club assignments saved!');
        });
        
        async function generateFixtures(legs) {
            const { leagueId, leagueName } = activeFixtureLeague;
            const league = leagues.find(l => l.id === leagueId);
            if (!league || !league.roster || league.roster.length < 2) {
                alert('League must have at least two players to generate fixtures.');
                return;
            }
            const batch = writeBatch(db);
            const roster = league.roster;
            for (let i = 0; i < roster.length; i++) {
                for (let j = i + 1; j < roster.length; j++) {
                    const match1 = { league: leagueName, player1Name: roster[i], player2Name: roster[j], status: 'pending', timestamp: Date.now() };
                    batch.set(doc(collection(db, 'matches')), match1);
                    if (legs === 2) {
                        const match2 = { league: leagueName, player1Name: roster[j], player2Name: roster[i], status: 'pending', timestamp: Date.now() + 1 };
                        batch.set(doc(collection(db, 'matches')), match2);
                    }
                }
            }
            await batch.commit();
            
            const leagueRef = doc(db, 'leagues', leagueId);
            await updateDoc(leagueRef, { fixturesGenerated: true });
            
            fixtureOptionsModal.style.display = 'none';
            alert('Fixtures generated successfully!');
        }

        document.getElementById('generateSingleLeg').addEventListener('click', () => generateFixtures(1));
        document.getElementById('generateDoubleLeg').addEventListener('click', () => generateFixtures(2));

        function openEnterResultModal(matchId) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;
            
            enterResultModal.querySelector('.modal-content').innerHTML = `
                <h2 class="text-2xl mb-4">Enter Match Result</h2>
                <form id="enterResultForm">
                    <input type="hidden" id="resultMatchId" value="${matchId}">
                    <div class="flex items-center justify-center gap-4">
                        <div class="text-center">
                            <label class="block mb-2 font-bold">${match.player1Name}</label>
                            <input type="number" id="resultPlayer1Goals" required class="w-24 text-center text-2xl">
                        </div>
                        <span class="text-2xl font-bold">vs</span>
                        <div class="text-center">
                            <label class="block mb-2 font-bold">${match.player2Name}</label>
                            <input type="number" id="resultPlayer2Goals" required class="w-24 text-center text-2xl">
                        </div>
                    </div>
                    <div class="flex justify-center gap-4 mt-6">
                        <button type="button" class="cancel-button bg-gray-600 hover:bg-gray-500 text-white">Cancel</button>
                        <button type="submit">Save Result</button>
                    </div>
                </form>
            `;
            enterResultModal.style.display = 'flex';
        }
        
        enterResultModal.addEventListener('submit', async (e) => {
             e.preventDefault();
            if (e.target.id !== 'enterResultForm') return;
            const matchId = document.getElementById('resultMatchId').value;
            const player1Goals = parseInt(document.getElementById('resultPlayer1Goals').value);
            const player2Goals = parseInt(document.getElementById('resultPlayer2Goals').value);

            if (!isNaN(player1Goals) && !isNaN(player2Goals)) {
                const matchRef = doc(db, 'matches', matchId);
                await updateDoc(matchRef, { player1Goals, player2Goals, status: 'completed' });
                enterResultModal.style.display = 'none';
            }
        });
        
        function openEditModal(matchId) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;

             editMatchModal.querySelector('.modal-content').innerHTML = `
                <h2 class="text-2xl mb-4">Edit Match Score</h2>
                <form id="editMatchForm">
                    <input type="hidden" id="editMatchId" value="${matchId}">
                    <div class="flex items-center justify-center gap-4">
                        <div class="text-center">
                            <label class="block mb-2 font-bold">${match.player1Name}</label>
                            <input type="number" id="editPlayer1Goals" value="${match.player1Goals}" required class="w-24 text-center text-2xl">
                        </div>
                        <span class="text-2xl font-bold">vs</span>
                        <div class="text-center">
                            <label class="block mb-2 font-bold">${match.player2Name}</label>
                            <input type="number" id="editPlayer2Goals" value="${match.player2Goals}" required class="w-24 text-center text-2xl">
                        </div>
                    </div>
                    <div class="flex justify-center gap-4 mt-6">
                        <button type="button" class="cancel-button bg-gray-600 hover:bg-gray-500 text-white">Cancel</button>
                        <button type="submit">Save Changes</button>
                    </div>
                </form>
            `;
            editMatchModal.style.display = 'flex';
        }
        
        editMatchModal.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (e.target.id !== 'editMatchForm') return;
            const matchId = document.getElementById('editMatchId').value;
            const player1Goals = parseInt(document.getElementById('editPlayer1Goals').value);
            const player2Goals = parseInt(document.getElementById('editPlayer2Goals').value);

            if (!isNaN(player1Goals) && !isNaN(player2Goals)) {
                const matchRef = doc(db, 'matches', matchId);
                await updateDoc(matchRef, { player1Goals, player2Goals });
                editMatchModal.style.display = 'none';
            }
        });
        
        function openEditPlayerModal(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            editPlayerModal.querySelector('.modal-content').innerHTML = `
                 <h2 class="text-2xl mb-4">Edit Player</h2>
                <form id="editPlayerForm" class="flex flex-col gap-4">
                    <input type="hidden" id="editPlayerId" value="${playerId}">
                    <div><label class="block mb-1">Name</label><input type="text" id="editPlayerName" value="${player.name}" required class="w-full"></div>
                    <div><label class="block mb-1">Email</label><input type="email" id="editPlayerEmail" value="${player.email || ''}" class="w-full"></div>
                    <div><label class="block mb-1">Avatar URL</label><input type="url" id="editPlayerAvatar" value="${player.avatarUrl || ''}" class="w-full"></div>
                    <div class="flex justify-end gap-4 mt-4">
                        <button type="button" class="cancel-button bg-gray-600 hover:bg-gray-500 text-white">Cancel</button>
                        <button type="submit">Save Player</button>
                    </div>
                </form>
            `;
            editPlayerModal.style.display = 'flex';
        }
        
        editPlayerModal.addEventListener('submit', async (e) => {
             e.preventDefault();
            if (e.target.id !== 'editPlayerForm') return;
            const playerId = document.getElementById('editPlayerId').value;
            const name = document.getElementById('editPlayerName').value.trim();
            const email = document.getElementById('editPlayerEmail').value.trim();
            const avatarUrl = document.getElementById('editPlayerAvatar').value.trim();

            if (name) {
                await updateDoc(doc(db, 'players', playerId), { name, email, avatarUrl });
                editPlayerModal.style.display = 'none';
            }
        });

         function openEditLeagueModal(leagueId) {
            const league = leagues.find(l => l.id === leagueId);
            if (!league) return;

            editLeagueModal.querySelector('.modal-content').innerHTML = `
                 <h2 class="text-2xl mb-4">Edit League</h2>
                <form id="editLeagueForm" class="flex flex-col gap-4">
                    <input type="hidden" id="editLeagueId" value="${leagueId}">
                    <div><label class="block mb-1">League Name</label><input type="text" id="editLeagueName" value="${league.name}" required class="w-full"></div>
                    <div class="flex justify-end gap-4 mt-4">
                        <button type="button" class="cancel-button bg-gray-600 hover:bg-gray-500 text-white">Cancel</button>
                        <button type="submit">Save Name</button>
                    </div>
                </form>
            `;
            editLeagueModal.style.display = 'flex';
        }

        editLeagueModal.addEventListener('submit', async (e) => {
             e.preventDefault();
            if (e.target.id !== 'editLeagueForm') return;
            const leagueId = document.getElementById('editLeagueId').value;
            const newName = document.getElementById('editLeagueName').value.trim();

            if (newName) {
                await updateDoc(doc(db, 'leagues', leagueId), { name: newName });
                editLeagueModal.style.display = 'none';
            }
        });
        
         function openEditClubModal(clubId) {
            const club = clubs.find(c => c.id === clubId);
            if (!club) return;

            editClubModal.querySelector('.modal-content').innerHTML = `
                 <h2 class="text-2xl mb-4">Edit Club</h2>
                <form id="editClubForm" class="flex flex-col gap-4">
                    <input type="hidden" id="editClubId" value="${clubId}">
                    <div><label class="block mb-1">Club Name</label><input type="text" id="editClubName" value="${club.name}" required class="w-full"></div>
                    <div><label class="block mb-1">Club Logo URL</label><input type="url" id="editClubLogo" value="${club.logoUrl || ''}" class="w-full"></div>
                    <div class="flex justify-end gap-4 mt-4">
                        <button type="button" class="cancel-button bg-gray-600 hover:bg-gray-500 text-white">Cancel</button>
                        <button type="submit">Save Club</button>
                    </div>
                </form>
            `;
            editClubModal.style.display = 'flex';
        }
        
        editClubModal.addEventListener('submit', async (e) => {
             e.preventDefault();
            if (e.target.id !== 'editClubForm') return;
            const clubId = document.getElementById('editClubId').value;
            const name = document.getElementById('editClubName').value.trim();
            const logoUrl = document.getElementById('editClubLogo').value.trim();

            if (name) {
                await updateDoc(doc(db, 'clubs', clubId), { name, logoUrl });
                editClubModal.style.display = 'none';
            }
        });


        async function endLeague(leagueId, leagueName) {
            if (!confirm(`Are you sure you want to end the "${leagueName}" league? This will award titles and cancel all remaining pending games.`)) return;

            const leagueRef = doc(db, 'leagues', leagueId);
            const leagueData = leagues.find(l => l.id === leagueId);
            const completedMatches = matches.filter(m => m.league === leagueName && m.status === 'completed');
            const leaguePlayers = leagueData?.roster || [];

            const standings = calculateLeagueStats(completedMatches, leaguePlayers);
            const { topScorers, topDefenders } = calculateTopPlayers(completedMatches, leaguePlayers);
            
            const batch = writeBatch(db);
            const timestamp = Date.now();
            const leagueDate = leagueData.createdAt;

            if (standings[0]) batch.set(doc(collection(db, 'honors')), { playerName: standings[0].player, leagueName, award: 'Gold Medal', timestamp, leagueDate });
            if (standings[1]) batch.set(doc(collection(db, 'honors')), { playerName: standings[1].player, leagueName, award: 'Silver Medal', timestamp, leagueDate });
            if (standings[2]) batch.set(doc(collection(db, 'honors')), { playerName: standings[2].player, leagueName, award: 'Bronze Medal', timestamp, leagueDate });
            if (topScorers[0]) batch.set(doc(collection(db, 'honors')), { playerName: topScorers[0].player, leagueName, award: 'Top Scorer', timestamp, leagueDate });
            if (topDefenders[0]) batch.set(doc(collection(db, 'honors')), { playerName: topDefenders[0].player, leagueName, award: 'Best Defender', timestamp, leagueDate });
            
            const pendingInLeague = matches.filter(m => m.league === leagueName && m.status === 'pending');
            pendingInLeague.forEach(m => batch.delete(doc(db, 'matches', m.id)));

            batch.update(leagueRef, { status: 'ended' });

            await batch.commit();
            alert(`"${leagueName}" has been ended and titles have been awarded!`);
        }
        
        function calculateTopPlayers(leagueMatches, leaguePlayers) {
            const stats = {};
            leaguePlayers.forEach(p => { stats[p] = { player: p, played: 0, gf: 0, ga: 0 }; });
            leagueMatches.forEach(m => {
                stats[m.player1Name].played++; stats[m.player2Name].played++;
                stats[m.player1Name].gf += m.player1Goals; stats[m.player1Name].ga += m.player2Goals;
                stats[m.player2Name].gf += m.player2Goals; stats[m.player2Name].ga += m.player1Goals;
            });
            const allStats = Object.values(stats).filter(p => p.played > 0);
            const topScorers = [...allStats].sort((a,b) => b.gf - a.gf).slice(0, 1);
            const topDefenders = [...allStats].sort((a,b) => a.ga - b.ga).slice(0, 1);
            return { topScorers, topDefenders };
        }

         function calculateLeagueStats(leagueMatches, leaguePlayers) {
            const stats = {};
            leaguePlayers.forEach(p => {
                stats[p] = { player: p, played: 0, wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, gd: 0, points: 0 };
            });
            leagueMatches.forEach(m => {
                const s1 = stats[m.player1Name], s2 = stats[m.player2Name];
                if (!s1 || !s2) return;
                s1.played++; s2.played++;
                s1.gf += m.player1Goals; s1.ga += m.player2Goals;
                s2.gf += m.player2Goals; s2.ga += m.player1Goals;
                s1.gd = s1.gf - s1.ga; s2.gd = s2.gf - s2.ga;
                if (m.player1Goals > m.player2Goals) { s1.wins++; s1.points += 3; s2.losses++; }
                else if (m.player2Goals > m.player1Goals) { s2.wins++; s2.points += 3; s1.losses++; }
                else { s1.draws++; s1.points++; s2.draws++; s2.points++; }
            });
            return Object.values(stats).sort((a, b) => b.points - a.points || b.gd - a.gd || b.gf - a.gf);
        }

        document.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.delete-item-btn');
            if (deleteBtn) {
                const { type, id } = deleteBtn.dataset;
                let itemIdentifier = type;
                if (type === 'player' || type === 'league' || type === 'club') {
                    const item = (type === 'player' ? players : type === 'league' ? leagues : clubs).find(i => i.id === id);
                    itemIdentifier = `${type}: ${item.name}`;
                }
                if(confirm(`Are you sure you want to delete ${itemIdentifier}?`)) {
                    await deleteDoc(doc(db, `${type}s`, id));
                }
            }
            
            const generateBtn = e.target.closest('.generate-fixtures-btn');
            if (generateBtn && !generateBtn.disabled) {
                activeFixtureLeague = { leagueId: generateBtn.dataset.leagueId, leagueName: generateBtn.dataset.leagueName };
                fixtureOptionsModal.style.display = 'flex';
            }
            
            const endLeagueBtn = e.target.closest('.end-league-btn');
            if (endLeagueBtn && !endLeagueBtn.disabled) {
                await endLeague(endLeagueBtn.dataset.leagueId, endLeagueBtn.dataset.leagueName);
            }

            const resultBtn = e.target.closest('.enter-result-btn');
            if (resultBtn) openEnterResultModal(resultBtn.dataset.id);
            
            const editBtn = e.target.closest('.edit-item-btn');
            if (editBtn) {
                const { type, id } = editBtn.dataset;
                if(type === 'match') openEditModal(id);
                if(type === 'player') openEditPlayerModal(id);
                if(type === 'league') openEditLeagueModal(id);
                if(type === 'club') openEditClubModal(id);
            }
        });

        addPlayerForm.addEventListener('submit', async e => { 
            e.preventDefault(); 
            const pName = document.getElementById('playerNameInput').value.trim();
            const pEmail = document.getElementById('playerEmailInput').value.trim();
            const pAvatar = document.getElementById('playerAvatarInput').value.trim();
            if (pName && !players.find(p => p.name === pName)) { 
                await addDoc(collection(db, 'players'), { name: pName, email: pEmail, avatarUrl: pAvatar }); 
                addPlayerForm.reset(); 
            } else {
                alert('A player with this name already exists.');
            }
        });
        createLeagueForm.addEventListener('submit', async e => { 
            e.preventDefault(); 
            const lName = leagueNameInput.value.trim(); 
            const roster = Array.from(document.querySelectorAll('#playerRosterChecklist input:checked')).map(el => el.value);
            if (lName && roster.length >= 2) { 
                await addDoc(collection(db, 'leagues'), { name: lName, owner: userId, roster, fixturesGenerated: false, status: 'active', createdAt: Date.now() }); 
                createLeagueForm.reset();
            } else {
                alert('Please enter a league name and select at least two players.');
            }
        });
        addClubForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const clubName = document.getElementById('clubNameInput').value.trim();
            const clubLogo = document.getElementById('clubLogoInput').value.trim();
            if(clubName && !clubs.find(c => c.name === clubName)) {
                await addDoc(collection(db, 'clubs'), { name: clubName, logoUrl: clubLogo });
                addClubForm.reset();
            } else {
                 alert('A club with this name already exists.');
            }
        });
        
        document.querySelectorAll('.cancel-button').forEach(btn => btn.addEventListener('click', (e) => {
            e.target.closest('.modal').style.display = 'none';
        }));

        document.addEventListener('DOMContentLoaded', startApp);
    </script>
</body>
</html>
